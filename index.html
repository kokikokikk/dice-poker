<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Poker Ex</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { background-color: #2c3e50; color: white; font-family: 'Segoe UI', sans-serif; text-align: center; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding-bottom: 50px; user-select: none; }
        .container { max-width: 600px; width: 95%; padding: 20px; }
        
        /* ãƒœã‚¿ãƒ³é¡ */
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-size: 1rem; cursor: pointer; margin: 5px; font-weight: bold; width: 100%; max-width: 300px; transition: 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-green { background-color: #27ae60; color: white; }
        .btn-blue { background-color: #2980b9; color: white; }
        .btn-orange { background-color: #e67e22; color: white; }
        .btn-red { background-color: #c0392b; color: white; }
        .btn-gray { background-color: #7f8c8d; color: white; }
        .btn-small { width: auto; font-size: 0.9rem; padding: 5px 15px; }

        /* é€šè²¨è¡¨ç¤º */
        .wallet-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .currency { padding: 8px 20px; border-radius: 50px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 5px; }
        .gold { background-color: #f1c40f; color: #2c3e50; border: 2px solid #f39c12; }
        .silver { background-color: #bdc3c7; color: #2c3e50; border: 2px solid #95a5a6; }

        /* ãƒ€ã‚¤ã‚¹ */
        .dice-area { display: flex; justify-content: center; gap: 8px; margin: 20px 0; min-height: 60px; }
        .die { width: 50px; height: 50px; background: white; color: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border: 3px solid #bdc3c7; cursor: pointer; transition: 0.1s; box-shadow: 0 3px 0 #95a5a6; }
        .die.held { background: #f1c40f; border-color: #e67e22; transform: translateY(-5px); box-shadow: 0 8px 5px rgba(0,0,0,0.2); }
        .die.locked { background: #ecf0f1; color: #95a5a6; cursor: default; }
        .die.cpu { background: #e0e0e0; cursor: default; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒ«ãƒ¼ãƒ«èª¬æ˜) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal { background: #34495e; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; text-align: left; border: 2px solid #f1c40f; }
        .modal h2 { margin-top: 0; color: #f1c40f; text-align: center; }
        .hand-list { font-size: 0.9rem; line-height: 1.6; }
        .hand-rank { font-weight: bold; color: #e67e22; }

        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
        .screen { display: none; }
        .active { display: block !important; }

        input { padding: 10px; font-size: 1rem; text-align: center; border-radius: 5px; border: 1px solid #ccc; width: 80%; max-width: 250px; }
        .status { margin: 10px; font-size: 1.2rem; color: #f39c12; font-weight: bold; }
        .info-text { font-size: 0.9rem; color: #bdc3c7; margin: 5px 0; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ² Dice Poker Ex</h1>

    <div class="wallet-bar">
        <div class="currency gold">ğŸ’° <span id="disp-gold">---</span></div>
        <div class="currency silver">ğŸª™ <span id="disp-silver">---</span></div>
    </div>

    <div id="lobby-screen" class="screen active">
        <button class="btn btn-small btn-gray" onclick="toggleRuleModal(true)">ğŸ“– ãƒ«ãƒ¼ãƒ«ã¨å½¹ã‚’è¦‹ã‚‹</button>
        <br><br>

        <h3>ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ (Gold)</h3>
        <p class="info-text">å‚åŠ è²»: 100 Gold</p>
        <button class="btn btn-green" onclick="setupMultiplayer('host')">éƒ¨å±‹ã‚’ä½œã‚‹ (HOST)</button>
        <br>
        <div style="margin: 5px 0;">
            <input type="text" id="room-id-input" placeholder="éƒ¨å±‹IDã‚’å…¥åŠ›">
            <button class="btn btn-blue" onclick="setupMultiplayer('join')">éƒ¨å±‹ã«å…¥ã‚‹ (JOIN)</button>
        </div>

        <hr style="border-color:rgba(255,255,255,0.1); margin: 20px 0;">

        <h3>ğŸ¤– CPUå¯¾æˆ¦ (Silver)</h3>
        <p class="info-text">å‚åŠ è²»: 50 Silver</p>
        <select id="cpu-level" style="padding:10px; border-radius:5px; font-size:1rem; width:200px; margin-bottom:10px;">
            <option value="1">Level 1: åˆå¿ƒè€… (Easy)</option>
            <option value="2" selected>Level 2: ä¸€èˆ¬äºº (Normal)</option>
            <option value="3">Level 3: è³­åšå¸« (Hard)</option>
        </select>
        <br>
        <button class="btn btn-orange" onclick="startCpuGame()">CPUã¨æˆ¦ã†</button>
        
        <br><br>
        <button class="btn btn-small btn-red" onclick="resetWallet()">ğŸ’¸ ãŠé‡‘ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="game-screen" class="screen">
        <div style="font-size:0.9rem; color:#bdc3c7;" id="game-info">Mode: ---</div>
        
        <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; margin-top:10px;">
            <div class="status">ç›¸æ‰‹: <span id="op-status">å¾…æ©Ÿä¸­...</span></div>
            <div class="dice-area" id="op-dice-area">
                <div class="die cpu">?</div><div class="die cpu">?</div><div class="die cpu">?</div><div class="die cpu">?</div><div class="die cpu">?</div>
            </div>
            <div id="op-hand-name" style="font-size:0.9rem;"></div>
        </div>

        <div id="result-msg" style="font-size:1.8rem; font-weight:bold; margin:15px 0; min-height:2.5rem;"></div>

        <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px;">
            <div class="status">ã‚ãªãŸ: <span id="my-status">æº–å‚™ä¸­</span></div>
            <div class="dice-area" id="my-dice-area"></div>
            <div id="my-hand-name" style="font-size:1.1rem; color:#f1c40f; font-weight:bold;"></div>
            
            <button id="roll-btn" class="btn btn-green" onclick="rollAction()">ROLL (3å›)</button>
        </div>

        <div id="action-area" style="margin-top:20px; display:none;">
            <button class="btn btn-gray" onclick="backToLobby()">ğŸ  ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
        </div>
    </div>
</div>

<div id="rule-modal" class="modal-overlay" onclick="toggleRuleModal(false)">
    <div class="modal" onclick="event.stopPropagation()">
        <h2>ğŸ“– ãƒ«ãƒ¼ãƒ« & å½¹ä¸€è¦§</h2>
        <p>5ã¤ã®ã‚µã‚¤ã‚³ãƒ­ã‚’æœ€å¤§3å›æŒ¯ã£ã¦ã€ã‚ˆã‚Šå¼·ã„å½¹ã‚’ä½œã£ãŸæ–¹ã®å‹ã¡ã§ã™ã€‚<br>
        1æŠ•ç›®ãƒ»2æŠ•ç›®ã®å¾Œã«ã€æ®‹ã—ãŸã„ã‚µã‚¤ã‚³ãƒ­ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ŒHOLDï¼ˆå›ºå®šï¼‰ã€ã§ãã¾ã™ã€‚</p>
        
        <h3>ğŸ† å½¹ã®å¼·ã• (ä¸Šã»ã©å¼·ã„)</h3>
        <div class="hand-list">
            <span class="hand-rank">1. Five of a Kind (5ã‚«ãƒ¼ãƒ‰)</span><br>åŒã˜æ•°å­—ãŒ5ã¤ (ä¾‹: 77777)<br><br>
            <span class="hand-rank">2. Four of a Kind (4ã‚«ãƒ¼ãƒ‰)</span><br>åŒã˜æ•°å­—ãŒ4ã¤ (ä¾‹: 55551)<br><br>
            <span class="hand-rank">3. Full House (ãƒ•ãƒ«ãƒã‚¦ã‚¹)</span><br>3ã‚«ãƒ¼ãƒ‰ + 1ãƒšã‚¢ (ä¾‹: 33366)<br><br>
            <span class="hand-rank">4. Straight (ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ)</span><br>12345 ã¾ãŸã¯ 23456 ã®ä¸¦ã³<br><br>
            <span class="hand-rank">5. Three of a Kind (3ã‚«ãƒ¼ãƒ‰)</span><br>åŒã˜æ•°å­—ãŒ3ã¤ (ä¾‹: 22214)<br><br>
            <span class="hand-rank">6. Two Pair (2ãƒšã‚¢)</span><br>ãƒšã‚¢ãŒ2çµ„ (ä¾‹: 11445)<br><br>
            <span class="hand-rank">7. One Pair (1ãƒšã‚¢)</span><br>ãƒšã‚¢ãŒ1çµ„ (ä¾‹: 66123)<br><br>
            <span class="hand-rank">8. High Card (ãƒ–ã‚¿)</span><br>å½¹ãªã—ã€‚æ•°å­—ã®åˆè¨ˆãªã©ã¯é–¢ä¿‚ãªã—ã€‚
        </div>
        <br>
        <button class="btn btn-green" onclick="toggleRuleModal(false)">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    // â–¼â–¼â–¼â–¼â–¼ ã“ã“ã ã‘è‡ªåˆ†ã®è¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼â–¼â–¼
    const firebaseConfig = {
      apiKey: "AIzaSyD0micFDoWAHMpZdY2IPhjW3v2XLqloJX8",
      authDomain: "dice-poker-e9021.firebaseapp.com",
      databaseURL: "https://dice-poker-e9021-default-rtdb.firebaseio.com",
      projectId: "dice-poker-e9021",
      storageBucket: "dice-poker-e9021.firebasestorage.app",
      messagingSenderId: "730416248000",
      appId: "1:730416248000:web:349072ce1b17bcc139e925",
      measurementId: "G-KP58T1CMFN"
    };
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹å¤‰æ•° ---
    let myGold = 1000;
    let mySilver = 500;
    const BET_GOLD = 100;
    const BET_SILVER = 50;

    let gameMode = null; // 'multi' or 'cpu'
    let cpuLevel = 2;
    let roomId = null;
    let myRole = null; // 'host' or 'guest' (multi only)
    
    let myDice = [1,1,1,1,1];
    let opDice = [1,1,1,1,1];
    let heldDice = [false,false,false,false,false];
    let rollCount = 3;
    let isGameFinished = false;
    let lastResetTime = 0;

    // DOMè¦ç´ 
    const lobbyScreen = document.getElementById('lobby-screen');
    const gameScreen = document.getElementById('game-screen');
    const myDiceDiv = document.getElementById('my-dice-area');
    const opDiceDiv = document.getElementById('op-dice-area');
    const rollBtn = document.getElementById('roll-btn');
    const resultMsg = document.getElementById('result-msg');
    const actionArea = document.getElementById('action-area');
    const opStatus = document.getElementById('op-status');
    const myStatus = document.getElementById('my-status');

    // åˆæœŸåŒ–
    loadWallet();

    function loadWallet() {
        myGold = parseInt(localStorage.getItem('dp_gold') || 1000);
        mySilver = parseInt(localStorage.getItem('dp_silver') || 500);
        updateWalletUI();
    }
    function saveWallet() {
        localStorage.setItem('dp_gold', myGold);
        localStorage.setItem('dp_silver', mySilver);
        updateWalletUI();
    }
    function updateWalletUI() {
        document.getElementById('disp-gold').innerText = myGold;
        document.getElementById('disp-silver').innerText = mySilver;
    }
    function resetWallet() {
        if(!confirm("ãŠé‡‘ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;
        myGold = 1000;
        mySilver = 500;
        saveWallet();
    }

    function toggleRuleModal(show) {
        document.getElementById('rule-modal').style.display = show ? 'flex' : 'none';
    }

    // --- ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ•ãƒ­ãƒ¼ ---
    
    function backToLobby() {
        // ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãªã‚‰åˆ‡æ–­å‡¦ç†
        if(gameMode === 'multi' && roomId) {
            db.ref(`rooms/${roomId}/${myRole}`).remove();
        }
        window.location.reload();
    }

    // 1. CPUæˆ¦é–‹å§‹
    function startCpuGame() {
        if(mySilver < BET_SILVER) return alert("Silverã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        gameMode = 'cpu';
        cpuLevel = parseInt(document.getElementById('cpu-level').value);
        
        mySilver -= BET_SILVER; // å‚åŠ è²»å¾´å
        saveWallet();

        document.getElementById('game-info').innerText = "Mode: CPU Battle (Level " + cpuLevel + ")";
        startGameCommon();
        
        // CPUåˆæœŸåŒ–
        opStatus.innerText = "æ€è€ƒä¸­...";
        updateOpDiceVisuals([0,0,0,0,0], false); // éš ã™
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ“ä½œå¾…ã¡ã¸
    }

    // 2. ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤é–‹å§‹
    function setupMultiplayer(type) {
        if(myGold < BET_GOLD) return alert("Goldãƒãƒƒãƒ—ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        gameMode = 'multi';
        
        if(type === 'host') {
            roomId = Math.floor(1000 + Math.random()*9000).toString();
            myRole = 'host';
            initMultiDB();
        } else {
            roomId = document.getElementById('room-id-input').value;
            if(!roomId) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            myRole = 'guest';
            initMultiDB();
        }
    }

    function initMultiDB() {
        let updates = {};
        if(myRole === 'host') {
            updates = {
                resetSignal: Date.now(),
                host: { dice: [0,0,0,0,0], status: 'Thinking' },
                guest: { dice: [0,0,0,0,0], status: 'Waiting' }
            };
            db.ref('rooms/' + roomId).set(updates).then(onMultiReady);
        } else {
            // ã‚²ã‚¹ãƒˆå‚åŠ æ™‚ã¯è‡ªåˆ†ã®æ ã ã‘ç¢ºä¿
            db.ref(`rooms/${roomId}/guest`).set({ dice: [0,0,0,0,0], status: 'Thinking' }).then(onMultiReady);
        }
    }

    function onMultiReady() {
        myGold -= BET_GOLD; // å‚åŠ è²»
        saveWallet();
        document.getElementById('game-info').innerText = "Mode: Online (Room " + roomId + ")";
        startGameCommon();
        listenToRoom();
    }

    // --- ã‚²ãƒ¼ãƒ å…±é€šå‡¦ç† ---
    function startGameCommon() {
        lobbyScreen.classList.remove('active');
        gameScreen.classList.add('active');
        
        rollCount = 3;
        heldDice = [false,false,false,false,false];
        isGameFinished = false;
        resultMsg.innerText = "";
        actionArea.style.display = 'none';
        
        // UIãƒªã‚»ãƒƒãƒˆ
        rollBtn.disabled = false;
        rollBtn.innerText = "ROLL (3å›)";
        rollBtn.className = "btn btn-green";
        myStatus.innerText = "æº–å‚™ä¸­";
        
        document.getElementById('op-hand-name').innerText = "";
        document.getElementById('my-hand-name').innerText = "";
        
        initMyDiceUI();
    }

    function initMyDiceUI() {
        myDiceDiv.innerHTML = '';
        for(let i=0; i<5; i++){
            let d = document.createElement('div');
            d.className = 'die';
            d.innerText = '-';
            d.onclick = () => toggleHold(i, d);
            myDiceDiv.appendChild(d);
        }
    }

    function toggleHold(i, el) {
        if(rollCount <= 0 || rollCount === 3 || isGameFinished) return;
        heldDice[i] = !heldDice[i];
        if(heldDice[i]) el.classList.add('held'); else el.classList.remove('held');
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    function rollAction() {
        if(rollCount <= 0) return;
        
        // ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹
        for(let i=0; i<5; i++){
            if(!heldDice[i]) myDice[i] = Math.floor(Math.random()*6)+1;
        }
        rollCount--;
        
        // ç”»é¢æ›´æ–°
        let dies = myDiceDiv.children;
        for(let i=0; i<5; i++) dies[i].innerText = myDice[i];
        
        if(rollCount < 3) {
            document.getElementById('my-hand-name').innerText = getHand(myDice).name;
        }

        let statusText = (rollCount === 0) ? "ç¢ºå®šï¼" : "è€ƒãˆä¸­...";
        myStatus.innerText = statusText;

        // ãƒœã‚¿ãƒ³æ›´æ–°
        rollBtn.innerText = (rollCount > 0) ? `REROLL (ã‚ã¨${rollCount}å›)` : "å‹è² å¾…ã¡...";
        if(rollCount === 0) {
            rollBtn.disabled = true;
            rollBtn.className = "btn btn-gray";
        }

        // --- ãƒ¢ãƒ¼ãƒ‰åˆ¥å‡¦ç† ---
        if(gameMode === 'multi') {
            // Firebaseé€ä¿¡
            db.ref(`rooms/${roomId}/${myRole}`).update({
                dice: myDice,
                status: statusText
            });
        } else {
            // CPUæˆ¦é€²è¡Œ
            runCpuProcess();
        }
    }

    // --- CPUãƒ­ã‚¸ãƒƒã‚¯ ---
    function runCpuProcess() {
        if(isGameFinished) return;

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç¢ºå®šã—ãŸã‚‰CPUã‚‚çµæœã‚’å‡ºã™ï¼ˆç°¡æ˜“åŒ–ã®ãŸã‚ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…ã¤ä»•æ§˜ã«ã—ã¾ã™ï¼‰
        // ã‚‚ã—ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ„Ÿã‚’å‡ºã—ãŸã„ãªã‚‰ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®rollCountã«åˆã‚ã›ã¦CPUã‚‚å†…éƒ¨ã§rollCountæ¸›ã‚‰ã™æ¼”å‡ºãŒå¿…è¦ã§ã™ãŒã€
        // ä»Šå›ã¯ã€Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç¢ºå®šã€â†’ã€ŒCPUãŒä¸€ç¬ã§3å›æŒ¯ã£ã¦çµæœç™ºè¡¨ã€ã®æµã‚Œã«ã—ã¾ã™ã€‚
        
        if(rollCount === 0) {
            opStatus.innerText = "æ¼”ç®—ä¸­...";
            setTimeout(() => {
                // CPUãŒ3å›æŒ¯ã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                let cpuD = [0,0,0,0,0];
                let cpuHeld = [false,false,false,false,false];
                
                for(let turn=0; turn<3; turn++) {
                    // Roll
                    for(let i=0; i<5; i++) {
                        if(!cpuHeld[i]) cpuD[i] = Math.floor(Math.random()*6)+1;
                    }
                    
                    if(turn < 2) { // æœ€å¾Œã®ã‚¿ãƒ¼ãƒ³ä»¥å¤–ã¯Holdåˆ¤æ–­
                        cpuHeld = decideCpuHold(cpuD, cpuLevel);
                    }
                }
                
                // çµæœè¡¨ç¤º
                opDice = cpuD;
                updateOpDiceVisuals(opDice, true);
                opStatus.innerText = "ç¢ºå®šï¼";
                
                finishGame(myDice, opDice);
            }, 1000);
        } else {
            opStatus.innerText = "ç›¸æ‰‹ã‚‚è€ƒãˆä¸­...";
        }
    }

    function decideCpuHold(dice, level) {
        let held = [false,false,false,false,false];
        let counts = {};
        dice.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
        
        if(level === 1) { // Easy: ãƒ©ãƒ³ãƒ€ãƒ ã‹ã€6ã ã‘æ®‹ã™
            dice.forEach((val, i) => { if(val === 6 || Math.random() > 0.7) held[i] = true; });
        }
        else if (level === 2) { // Normal: ãƒšã‚¢ä»¥ä¸Šã¯æ®‹ã™
            dice.forEach((val, i) => { if(counts[val] >= 2) held[i] = true; });
        }
        else { // Hard: å½¹ä½œã‚Šå„ªå…ˆ
            // ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆç‹™ã„åˆ¤å®šã¯è¤‡é›‘ãªã®ã§ã€åŸºæœ¬ã¯ã€Œé‡è¤‡ãŒå¤šã„æ•°å­—ã€orã€Œé‡è¤‡ãŒãªã„ãªã‚‰é«˜ã„æ•°å­—ã€ã‚’æ®‹ã™
            let maxCount = Math.max(...Object.values(counts));
            if(maxCount >= 2) {
                // ãƒšã‚¢ä»¥ä¸ŠãŒã‚ã‚Œã°ãã‚Œã‚’å›ºã‚ã‚‹
                dice.forEach((val, i) => { if(counts[val] >= 2) held[i] = true; });
            } else {
                // ãƒãƒ©ãƒãƒ©ãªã‚‰ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆç‹™ã„ã‹HighCardç‹™ã„ï¼ˆ4ä»¥ä¸Šã‚’æ®‹ã™ï¼‰
                dice.forEach((val, i) => { if(val >= 4) held[i] = true; });
            }
        }
        return held;
    }

    // --- ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ç›£è¦– ---
    function listenToRoom() {
        db.ref('rooms/' + roomId).on('value', snap => {
            const data = snap.val();
            if(!data || isGameFinished) return;

            let opRole = (myRole === 'host') ? 'guest' : 'host';
            let opData = data[opRole];

            if(opData) {
                opStatus.innerText = opData.status;
                
                // ç›¸æ‰‹ãŒç¢ºå®šã™ã‚‹ã¾ã§ãƒ€ã‚¤ã‚¹ã¯éš ã™
                if(opData.status === "ç¢ºå®šï¼") {
                    opDice = opData.dice;
                }
                
                // è‡ªåˆ†ã®çŠ¶æ…‹ã‚‚ç¢ºèª
                if(rollCount === 0 && opData.status === "ç¢ºå®šï¼" && !isGameFinished) {
                    updateOpDiceVisuals(opDice, true);
                    finishGame(myDice, opDice);
                } else {
                    // ã¾ã é€”ä¸­ãªã‚‰éš ã—ã¦è¡¨ç¤º
                    updateOpDiceVisuals(opData.dice || [0,0,0,0,0], false);
                }
            }
        });
    }

    function updateOpDiceVisuals(dice, visible) {
        opDiceDiv.innerHTML = '';
        dice.forEach(val => {
            let d = document.createElement('div');
            d.className = 'die cpu';
            d.innerText = visible ? val : "?";
            if(visible) d.style.background = "white";
            opDiceDiv.appendChild(d);
        });
    }

    // --- å‹æ•—åˆ¤å®š ---
    function finishGame(myD, opD) {
        isGameFinished = true;
        let myHand = getHand(myD);
        let opHand = getHand(opD);

        document.getElementById('my-hand-name').innerText = myHand.name;
        document.getElementById('op-hand-name').innerText = opHand.name;

        let winAmount = 0;
        let isWin = false;
        
        if(myHand.rank > opHand.rank || (myHand.rank === opHand.rank && myHand.sum > opHand.sum)) { // ç°¡æ˜“çš„ã«åŒãƒ©ãƒ³ã‚¯ãªã‚‰åˆè¨ˆå€¤å‹è² 
            isWin = true;
            resultMsg.innerText = "ğŸ† YOU WIN!!";
            resultMsg.style.color = "#f1c40f";
        } else if (myHand.rank < opHand.rank || (myHand.rank === opHand.rank && myHand.sum < opHand.sum)) {
            resultMsg.innerText = "ğŸ’€ YOU LOSE...";
            resultMsg.style.color = "#e74c3c";
        } else {
            resultMsg.innerText = "ğŸ¤ DRAW";
            resultMsg.style.color = "white";
        }

        // å ±é…¬è¨ˆç®—
        if(gameMode === 'cpu') {
            if(isWin) {
                // CPUæˆ¦ã¯ã‚ªãƒƒã‚º2å€(å‚åŠ è²»50æˆ»ã‚Š+50å‹ã¡=100) + ãƒ¬ãƒ™ãƒ«ãƒœãƒ¼ãƒŠã‚¹
                let bonus = (cpuLevel - 1) * 20; 
                let reward = (BET_SILVER * 2) + bonus;
                mySilver += reward;
                resultMsg.innerText += ` (+${reward - BET_SILVER} Silver)`;
            } else if (resultMsg.innerText.includes("DRAW")) {
                mySilver += BET_SILVER; // å¼•ãåˆ†ã‘ã¯è¿”é‡‘
            }
        } else {
            if(isWin) {
                // ãƒãƒ«ãƒã¯ç·å–ã‚Š (å‚åŠ è²»100 * 2 = 200)
                myGold += (BET_GOLD * 2);
                resultMsg.innerText += ` (+${BET_GOLD} Gold)`;
            } else if (resultMsg.innerText.includes("DRAW")) {
                myGold += BET_GOLD;
            }
        }
        
        saveWallet();
        actionArea.style.display = 'block';
    }

    function getHand(dice) {
        if(!dice || dice.includes(0)) return {rank:0, name:"---", sum:0};
        let counts = {};
        let sum = 0;
        dice.forEach(x => { counts[x] = (counts[x] || 0) + 1; sum += x; });
        let values = Object.values(counts).sort((a,b) => b - a);
        let uniqueDice = [...new Set(dice)].sort().join('');
        let isStraight = (uniqueDice === '12345' || uniqueDice === '23456');

        if (values[0] === 5) return { rank: 8, name: "Five of a Kind", sum };
        if (values[0] === 4) return { rank: 7, name: "Four of a Kind", sum };
        if (values[0] === 3 && values[1] === 2) return { rank: 6, name: "Full House", sum };
        if (isStraight) return { rank: 5, name: "Straight", sum };
        if (values[0] === 3) return { rank: 4, name: "Three of a Kind", sum };
        if (values[0] === 2 && values[1] === 2) return { rank: 3, name: "Two Pair", sum };
        if (values[0] === 2) return { rank: 2, name: "One Pair", sum };
        return { rank: 1, name: "High Card", sum };
    }
</script>
</body>
</html>
