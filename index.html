<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Dice Poker</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { background-color: #2c3e50; color: white; font-family: sans-serif; text-align: center; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        .container { max-width: 600px; width: 95%; padding: 20px; }
        .btn { padding: 10px 20px; border-radius: 5px; border: none; font-size: 1rem; cursor: pointer; margin: 5px; font-weight: bold; }
        .btn-green { background-color: #27ae60; color: white; }
        .btn-blue { background-color: #2980b9; color: white; }
        .btn-red { background-color: #e74c3c; color: white; display: none; margin-top: 20px; width: 100%; font-size: 1.2rem; padding: 15px; box-shadow: 0 5px 0 #c0392b; }
        .btn-red:active { transform: translateY(5px); box-shadow: none; }
        
        input { padding: 10px; font-size: 1rem; text-align: center; }
        .dice-area { display: flex; justify-content: center; gap: 10px; margin: 20px 0; min-height: 60px; }
        .die { width: 50px; height: 50px; background: white; color: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border: 3px solid transparent; }
        .die.held { background: #f1c40f; border-color: #e67e22; transform: translateY(-5px); }
        .status { margin: 15px; font-size: 1.2rem; color: #f39c12; }
        #setup-screen, #game-screen { display: none; }
        .active { display: block !important; }
        
        .room-display { background-color: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; display: inline-block; margin-bottom: 10px; border: 2px solid #f1c40f; color: #f1c40f; font-weight: bold; font-size: 1.2rem; }
        
        /* è‡ªåˆ†ã®ãƒãƒƒãƒ—è¡¨ç¤º */
        .chip-display { background-color: #f39c12; color: #2c3e50; padding: 10px 20px; border-radius: 50px; font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: inline-block; }
        
        /* ç›¸æ‰‹ã®ãƒãƒƒãƒ—è¡¨ç¤ºï¼ˆå°‘ã—å°ã•ã‚ï¼‰ */
        .chip-display-small { font-size: 1rem; color: #bdc3c7; margin-bottom: 5px; font-weight: bold; }
        
        #result-msg { font-size: 2rem; font-weight: bold; margin: 20px 0; min-height: 3rem; text-shadow: 2px 2px 0 #000; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ² Online Dice Poker</h1>

    <div id="setup-screen" class="active">
        <div class="chip-display">æ‰€æŒé‡‘: $<span id="title-chips">---</span></div>
        <br>
        <p>å‹é”ã¨éŠã¶ãŸã‚ã®ã€Œéƒ¨å±‹ã€ã‚’ä½œã‚ã†</p>
        <button class="btn btn-green" onclick="createRoom()">éƒ¨å±‹ã‚’ä½œã‚‹ (HOST)</button>
        <br><br>
        <p>ã¾ãŸã¯ã€å‹é”ã®éƒ¨å±‹IDã‚’å…¥åŠ›</p>
        <input type="text" id="room-id-input" placeholder="éƒ¨å±‹IDã‚’å…¥åŠ›">
        <button class="btn btn-blue" onclick="joinRoom()">éƒ¨å±‹ã«å…¥ã‚‹ (JOIN)</button>
        <br><br>
        <button class="btn" style="background:#95a5a6; font-size:0.8rem;" onclick="resetChips()">ğŸ’¸ æ‰€æŒé‡‘ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="game-screen">
        <div class="chip-display">æ‰€æŒé‡‘: $<span id="game-chips">---</span></div>
        <br>
        <div id="game-room-display" class="room-display">ID: ----</div>
        
        <div id="result-msg"></div>

        <div class="chip-display-small">ç›¸æ‰‹ã®æ‰€æŒé‡‘: $<span id="opponent-chips">---</span></div>
        <div class="status">ç›¸æ‰‹: <span id="opponent-status">å¾…æ©Ÿä¸­...</span></div>
        <div class="dice-area" id="opponent-dice">
            <div class="die">?</div><div class="die">?</div><div class="die">?</div><div class="die">?</div><div class="die">?</div>
        </div>
        <div id="op-hand-name" style="font-size:0.9rem; color:#bdc3c7;"></div>

        <hr style="opacity:0.3; margin: 20px 0;">
        
        <div class="status">ã‚ãªãŸ: <span id="my-status">æº–å‚™ä¸­</span></div>
        <div class="dice-area" id="my-dice"></div>
        <div id="my-hand-name" style="font-size:0.9rem; color:#f1c40f; font-weight:bold;"></div>
        
        <button id="roll-btn" class="btn btn-green" onclick="rollAction()">ROLL (3å›)</button>
        
        <button id="next-btn" class="btn btn-red" onclick="resetGame()">æ¬¡ã®ã‚²ãƒ¼ãƒ ã¸ (RESTART)</button>
        
        <p id="msg">ã‚¯ãƒªãƒƒã‚¯ã—ã¦HOLD / ROLLã§ç¢ºå®š</p>
    </div>
</div>

<script>
    // â–¼â–¼â–¼â–¼â–¼ ã“ã“ã ã‘è‡ªåˆ†ã®è¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼â–¼â–¼
    const firebaseConfig = {
      apiKey: "AIzaSyD0micFDoWAHMpZdY2IPhjW3v2XLqloJX8",
      authDomain: "dice-poker-e9021.firebaseapp.com",
      databaseURL: "https://dice-poker-e9021-default-rtdb.firebaseio.com",
      projectId: "dice-poker-e9021",
      storageBucket: "dice-poker-e9021.firebasestorage.app",
      messagingSenderId: "730416248000",
      appId: "1:730416248000:web:349072ce1b17bcc139e925",
      measurementId: "G-KP58T1CMFN"
    };

    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let roomId = null;
    let myRole = null;
    let myDice = [1,1,1,1,1];
    let heldDice = [false,false,false,false,false];
    let rollCount = 3;
    let isGameFinished = false;
    let lastResetTime = 0;
    
    // ãƒãƒƒãƒ—ç®¡ç†
    let myChips = 1000;
    let opponentChipsValue = 1000; // ç›¸æ‰‹ã®ãƒãƒƒãƒ—ã‚’ä¸€æ™‚ä¿å­˜ã™ã‚‹å¤‰æ•°
    const BET_AMOUNT = 100;

    const setupScreen = document.getElementById('setup-screen');
    const gameScreen = document.getElementById('game-screen');
    const myDiceDiv = document.getElementById('my-dice');
    const opDiceDiv = document.getElementById('opponent-dice');
    const roomDisplay = document.getElementById('game-room-display');
    const resultMsg = document.getElementById('result-msg');
    const nextBtn = document.getElementById('next-btn');
    const titleChips = document.getElementById('title-chips');
    const gameChips = document.getElementById('game-chips');
    const opChipsDisplay = document.getElementById('opponent-chips');

    loadChips();

    function loadChips() {
        const saved = localStorage.getItem('dicePokerChips');
        if (saved) {
            myChips = parseInt(saved);
        } else {
            myChips = 1000;
        }
        updateChipDisplay();
    }

    function saveChips() {
        localStorage.setItem('dicePokerChips', myChips);
        updateChipDisplay();
    }
    
    function resetChips() {
        if(confirm("æœ¬å½“ã«æ‰€æŒé‡‘ã‚’$1000ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
            myChips = 1000;
            saveChips();
        }
    }

    function updateChipDisplay() {
        titleChips.innerText = myChips;
        gameChips.innerText = myChips;
    }

    function createRoom() {
        if(myChips < BET_AMOUNT) return alert("ãƒãƒƒãƒ—ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚");
        roomId = Math.floor(1000 + Math.random() * 9000).toString();
        myRole = 'host';
        resetDB(); 
    }

    function joinRoom() {
        if(myChips < BET_AMOUNT) return alert("ãƒãƒƒãƒ—ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚");
        roomId = document.getElementById('room-id-input').value;
        if (!roomId) return alert("éƒ¨å±‹IDã‚’å…¥ã‚Œã¦ã­");
        myRole = 'guest';
        roomDisplay.innerText = "éƒ¨å±‹ID: " + roomId;
        
        // ã‚²ã‚¹ãƒˆå‚åŠ æ™‚ã«è‡ªåˆ†ã®ãƒãƒƒãƒ—æƒ…å ±ã‚’æ›¸ãè¾¼ã‚€ï¼ˆã“ã“é‡è¦ï¼ï¼‰
        db.ref(`rooms/${roomId}/guest`).update({
            chips: myChips
        });
        
        listenToRoom();
        startGameUI();
    }

    function resetDB() {
        let now = Date.now();
        
        // ãƒªã‚»ãƒƒãƒˆæ™‚ã€ç›¸æ‰‹ã®ãƒãƒƒãƒ—æƒ…å ±ãŒæ¶ˆãˆãªã„ã‚ˆã†ã«ã€Œæœ€å¾Œã«è¦šãˆã¦ã„ã‚‹ç›¸æ‰‹ã®é¡ã€ã‚’ä½¿ã†
        let hostChips = (myRole === 'host') ? myChips : opponentChipsValue;
        let guestChips = (myRole === 'guest') ? myChips : opponentChipsValue;

        db.ref('rooms/' + roomId).set({
            host: { dice: [0,0,0,0,0], status: 'Thinking', chips: hostChips },
            guest: { dice: [0,0,0,0,0], status: 'Waiting', chips: guestChips },
            resetSignal: now 
        }).then(() => {
            roomDisplay.innerText = "éƒ¨å±‹ID: " + roomId;
            // ãƒ›ã‚¹ãƒˆã®å ´åˆã¯è‡ªåˆ†ã®lastResetTimeã‚’æ›´æ–°ã—ã¦ãŠã
            if(myRole === 'host') lastResetTime = now;
            listenToRoom();
        });
    }
    
    function resetGame() {
        if(myChips < BET_AMOUNT) {
            alert("ç ´ç”£ã—ã¾ã—ãŸ...ï¼ã‚‚ã†è³­ã‘ã‚‰ã‚Œã¾ã›ã‚“ã€‚\nãƒˆãƒƒãƒ—ã«æˆ»ã£ã¦ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚");
            location.reload();
            return;
        }
        resetDB();
    }

    function startGameUI() {
        setupScreen.classList.remove('active');
        gameScreen.classList.add('active');
        
        rollCount = 3;
        heldDice = [false,false,false,false,false];
        isGameFinished = false;
        
        resultMsg.innerText = "";
        nextBtn.style.display = "none";
        
        document.getElementById('roll-btn').disabled = false;
        document.getElementById('roll-btn').style.backgroundColor = "#27ae60";
        document.getElementById('roll-btn').innerText = "ROLL (3å›)";
        document.getElementById('op-hand-name').innerText = "";
        document.getElementById('my-hand-name').innerText = "";
        
        initMyDice();
    }

    function initMyDice() {
        myDiceDiv.innerHTML = '';
        for(let i=0; i<5; i++){
            let d = document.createElement('div');
            d.className = 'die';
            d.innerText = '-';
            d.onclick = () => toggleHold(i, d);
            myDiceDiv.appendChild(d);
        }
    }

    function toggleHold(i, el) {
        if(rollCount <= 0 || rollCount === 3 || isGameFinished) return;
        heldDice[i] = !heldDice[i];
        if(heldDice[i]) el.classList.add('held'); else el.classList.remove('held');
    }

    function rollAction() {
        if(rollCount <= 0) return;
        for(let i=0; i<5; i++){
            if(!heldDice[i]) myDice[i] = Math.floor(Math.random()*6)+1;
        }
        rollCount--;
        updateMyVisuals();

        let statusText = (rollCount === 0) ? "ç¢ºå®šï¼" : "è€ƒãˆä¸­...";
        
        // è‡ªåˆ†ã®ãƒãƒƒãƒ—æƒ…å ±ã‚‚ä¸€ç·’ã«é€ä¿¡ã™ã‚‹
        db.ref(`rooms/${roomId}/${myRole}`).set({
            dice: myDice,
            status: statusText,
            chips: myChips
        });

        document.getElementById('roll-btn').innerText = (rollCount > 0) ? `REROLL (ã‚ã¨${rollCount}å›)` : "å‹è² å¾…ã¡...";
        if(rollCount === 0) {
            document.getElementById('roll-btn').disabled = true;
            document.getElementById('roll-btn').style.backgroundColor = "#7f8c8d";
        }
    }

    function updateMyVisuals() {
        let dies = myDiceDiv.children;
        for(let i=0; i<5; i++) dies[i].innerText = myDice[i];
        if(rollCount < 3) document.getElementById('my-hand-name').innerText = getHandName(myDice).name;
    }

    function listenToRoom() {
        db.ref('rooms/' + roomId).on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            if (data.resetSignal && data.resetSignal > lastResetTime) {
                lastResetTime = data.resetSignal;
                startGameUI();
                return; 
            }

            let opponentRole = (myRole === 'host') ? 'guest' : 'host';
            let opData = data[opponentRole];
            let myData = data[myRole];

            if (opData) {
                // ç›¸æ‰‹ã®ãƒãƒƒãƒ—æƒ…å ±ã‚’è¡¨ç¤ºï¼†è¨˜æ†¶
                if (opData.chips !== undefined) {
                    opponentChipsValue = opData.chips;
                    opChipsDisplay.innerText = opData.chips;
                }
                
                document.getElementById('opponent-status').innerText = opData.status;
                opDiceDiv.innerHTML = '';
                
                if (opData.dice) {
                    opData.dice.forEach(val => {
                        let d = document.createElement('div');
                        d.className = 'die';
                        if (isGameFinished) {
                            d.innerText = val;
                            d.style.backgroundColor = "#bdc3c7";
                        } else {
                            d.innerText = "?";
                        }
                        opDiceDiv.appendChild(d);
                    });
                }

                if (opData.status === "ç¢ºå®šï¼" && myData.status === "ç¢ºå®šï¼" && !isGameFinished) {
                    isGameFinished = true;
                    
                    // å¼·åˆ¶å†æç”»ï¼ˆæ‰‹æœ­ã‚ªãƒ¼ãƒ—ãƒ³ï¼‰
                    opDiceDiv.innerHTML = '';
                    opData.dice.forEach(val => {
                        let d = document.createElement('div');
                        d.className = 'die';
                        d.innerText = val;
                        d.style.backgroundColor = "#bdc3c7";
                        opDiceDiv.appendChild(d);
                    });
                    
                    judgeWinner(myData.dice, opData.dice);
                }
            }
        });
    }

    function judgeWinner(myD, opD) {
        let myHand = getHandName(myD);
        let opHand = getHandName(opD);
        
        document.getElementById('my-hand-name').innerText = myHand.name;
        document.getElementById('op-hand-name').innerText = opHand.name;
        
        let winAmount = BET_AMOUNT;

        if (myHand.rank > opHand.rank) {
            resultMsg.innerText = "YOU WIN!! (+$" + winAmount + ") ğŸ†";
            resultMsg.style.color = "#f1c40f";
            myChips += winAmount;
        } else if (myHand.rank < opHand.rank) {
            resultMsg.innerText = "YOU LOSE... (-$" + winAmount + ") ğŸ˜¢";
            resultMsg.style.color = "#e74c3c";
            myChips -= winAmount;
        } else {
            resultMsg.innerText = "DRAW (Â±0)";
            resultMsg.style.color = "#fff";
        }
        
        saveChips();
        // å‹æ•—ãŒæ±ºã¾ã£ãŸã‚‰ã€æœ€æ–°ã®ãƒãƒƒãƒ—é¡ã‚’DBã«é€ã£ã¦ç›¸æ‰‹ã«è¦‹ã›ã‚‹
        db.ref(`rooms/${roomId}/${myRole}/chips`).set(myChips);
        
        nextBtn.style.display = "block";
    }

    function getHandName(dice) {
        if(!dice) return {rank:0, name:""};
        let counts = {};
        dice.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
        let values = Object.values(counts).sort((a,b) => b - a);
        let uniqueDice = [...new Set(dice)].sort().join('');
        let isStraight = (uniqueDice === '12345' || uniqueDice === '23456');

        if (values[0] === 5) return { rank: 8, name: "Five of a Kind! (5ã‚«ãƒ¼ãƒ‰)" };
        if (values[0] === 4) return { rank: 7, name: "Four of a Kind (4ã‚«ãƒ¼ãƒ‰)" };
        if (values[0] === 3 && values[1] === 2) return { rank: 6, name: "Full House (ãƒ•ãƒ«ãƒã‚¦ã‚¹)" };
        if (isStraight) return { rank: 5, name: "Straight (ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ)" };
        if (values[0] === 3) return { rank: 4, name: "Three of a Kind (3ã‚«ãƒ¼ãƒ‰)" };
        if (values[0] === 2 && values[1] === 2) return { rank: 3, name: "Two Pair (2ãƒšã‚¢)" };
        if (values[0] === 2) return { rank: 2, name: "One Pair (1ãƒšã‚¢)" };
        return { rank: 1, name: "High Card (ãƒ–ã‚¿)" };
    }
</script>
</body>
</html>
