<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dice Poker Ex</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { 
            background-color: #2c3e50; color: white; font-family: 'Segoe UI', sans-serif; 
            text-align: center; display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; margin: 0; padding-bottom: 50px; user-select: none; 
            touch-action: manipulation;
        }
        .container { max-width: 600px; width: 95%; padding: 20px; }
        
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-size: 1rem; cursor: pointer; margin: 5px; font-weight: bold; width: 100%; max-width: 300px; transition: 0.1s; touch-action: manipulation; }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-green { background-color: #27ae60; color: white; }
        .btn-blue { background-color: #2980b9; color: white; }
        .btn-orange { background-color: #e67e22; color: white; }
        .btn-red { background-color: #c0392b; color: white; }
        .btn-gray { background-color: #7f8c8d; color: white; }
        .btn-small { width: auto; font-size: 0.9rem; padding: 5px 15px; }

        .wallet-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .currency { padding: 8px 20px; border-radius: 50px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 5px; }
        .gold { background-color: #f1c40f; color: #2c3e50; border: 2px solid #f39c12; }
        .silver { background-color: #bdc3c7; color: #2c3e50; border: 2px solid #95a5a6; }

        .dice-area { display: flex; justify-content: center; gap: 8px; margin: 20px 0; min-height: 60px; }
        .die { width: 50px; height: 50px; background: white; color: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border: 3px solid #bdc3c7; cursor: pointer; transition: 0.1s; box-shadow: 0 3px 0 #95a5a6; touch-action: manipulation; }
        .die.held { background: #f1c40f; border-color: #e67e22; transform: translateY(-5px); box-shadow: 0 8px 5px rgba(0,0,0,0.2); }
        .die.locked { background: #ecf0f1; color: #95a5a6; cursor: default; }
        .die.cpu { background: #e0e0e0; cursor: default; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal { background: #34495e; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; text-align: left; border: 2px solid #f1c40f; }
        .modal h2 { margin-top: 0; color: #f1c40f; text-align: center; }
        .hand-list { font-size: 0.9rem; line-height: 1.6; }
        .hand-rank { font-weight: bold; color: #e67e22; }

        .screen { display: none; }
        .active { display: block !important; }

        input { padding: 10px; font-size: 1rem; text-align: center; border-radius: 5px; border: 1px solid #ccc; width: 80%; max-width: 250px; }
        .status { margin: 10px; font-size: 1.2rem; color: #f39c12; font-weight: bold; }
        .info-text { font-size: 0.9rem; color: #bdc3c7; margin: 5px 0; }
        .action-row { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        
        .name-label { font-size: 0.8rem; color: #bdc3c7; display: block; margin-bottom: 2px; }
        .player-info { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ² Dice Poker Ex</h1>

    <div class="wallet-bar">
        <div class="currency gold">ğŸ’° <span id="disp-gold">---</span></div>
        <div class="currency silver">ğŸª™ <span id="disp-silver">---</span></div>
    </div>

    <div id="lobby-screen" class="screen active">
        <button class="btn btn-small btn-gray" onclick="toggleRuleModal(true)">ğŸ“– ãƒ«ãƒ¼ãƒ«ã¨å½¹ã‚’è¦‹ã‚‹</button>
        <br><br>

        <label class="name-label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
        <input type="text" id="player-name-input" placeholder="åå‰ã‚’å…¥åŠ›" onchange="saveName()">
        <br><br>

        <h3>ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ (Gold)</h3>
        <p class="info-text">å‚åŠ è²»: 100 Gold</p>
        <button class="btn btn-green" onclick="setupMultiplayer('host')">éƒ¨å±‹ã‚’ä½œã‚‹ (HOST)</button>
        <br>
        <div style="margin: 5px 0;">
            <input type="text" id="room-id-input" placeholder="éƒ¨å±‹IDã‚’å…¥åŠ›">
            <button class="btn btn-blue" onclick="setupMultiplayer('join')">éƒ¨å±‹ã«å…¥ã‚‹ (JOIN)</button>
        </div>

        <hr style="border-color:rgba(255,255,255,0.1); margin: 20px 0;">

        <h3>ğŸ¤– CPUå¯¾æˆ¦ (Silver)</h3>
        <p class="info-text">å‚åŠ è²»: <span id="cpu-cost-display" style="color:#f1c40f; font-weight:bold;">50</span> Silver</p>
        
        <select id="cpu-level" onchange="updateCpuCost()" style="padding:10px; border-radius:5px; font-size:1rem; width:250px; margin-bottom:10px;">
            <option value="1">Level 1: åˆå¿ƒè€… (20 Silver)</option>
            <option value="2" selected>Level 2: ä¸€èˆ¬äºº (50 Silver)</option>
            <option value="3">Level 3: è³­åšå¸« (100 Silver)</option>
        </select>
        <br>
        <button class="btn btn-orange" onclick="startCpuGame()">CPUã¨æˆ¦ã†</button>
        
        <br><br>
        
        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
            <button class="btn btn-small btn-gray" onclick="resetSilver()" style="border:2px solid #bdc3c7;">
                ğŸª™ Silverã‚’è£œå……
            </button>
            <button class="btn btn-small btn-green" onclick="resetGold()" style="border:2px solid #f1c40f;">
                ğŸ’° Goldã‚’è£œå……
            </button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div style="font-size:0.9rem; color:#bdc3c7;" id="game-info">Mode: ---</div>
        
        <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; margin-top:10px;">
            <div class="player-info">
                <span class="name-label" id="op-name-display">Unknown</span>
                <span class="name-label" id="op-gold-display"></span>
            </div>
            <div class="status">ç›¸æ‰‹: <span id="op-status">å¾…æ©Ÿä¸­...</span></div>
            <div class="dice-area" id="op-dice-area">
                <div class="die cpu">?</div><div class="die cpu">?</div><div class="die cpu">?</div><div class="die cpu">?</div><div class="die cpu">?</div>
            </div>
            <div id="op-hand-name" style="font-size:0.9rem;"></div>
        </div>

        <div id="result-msg" style="font-size:1.8rem; font-weight:bold; margin:15px 0; min-height:2.5rem;"></div>

        <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px;">
            <div class="status">ã‚ãªãŸ: <span id="my-status">æº–å‚™ä¸­</span></div>
            <div class="dice-area" id="my-dice-area"></div>
            <div id="my-hand-name" style="font-size:1.1rem; color:#f1c40f; font-weight:bold;"></div>
            
            <button id="roll-btn" class="btn btn-green" onclick="rollAction()">ROLL (3å›)</button>
        </div>

        <div id="cancel-wait-area" style="margin-top:20px; display:none;">
            <p>å¯¾æˆ¦ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
            <p style="font-size:0.8rem;">ID: <span id="room-id-display" style="font-weight:bold; color:#f1c40f;"></span> ã‚’å‹é”ã«æ•™ãˆã¦ãã ã•ã„</p>
            <button class="btn btn-red" onclick="cancelHost()">éƒ¨å±‹ã‚’è§£æ•£ã—ã¦æˆ»ã‚‹ (è¿”é‡‘)</button>
        </div>

        <div id="action-area" style="margin-top:20px; display:none;">
            <div class="action-row" id="cpu-actions" style="display:none;">
                <button class="btn btn-orange" onclick="restartCpuGame()">ğŸ”„ ã‚‚ã†ä¸€å› ($<span id="replay-cost"></span>)</button>
                <button class="btn btn-gray" onclick="backToLobby()">ğŸ  ãƒ­ãƒ“ãƒ¼ã¸</button>
            </div>
            <div class="action-row" id="multi-actions" style="display:none;">
                <button class="btn btn-orange" onclick="restartMultiGame()">ğŸ”„ ã‚‚ã†ä¸€å› ($100)</button>
                <button class="btn btn-gray" onclick="backToLobby()">ğŸ  ãƒ­ãƒ“ãƒ¼ã¸</button>
            </div>
        </div>
    </div>
</div>

<div id="rule-modal" class="modal-overlay" onclick="toggleRuleModal(false)">
    <div class="modal" onclick="event.stopPropagation()">
        <h2>ğŸ“– ãƒ«ãƒ¼ãƒ« & å½¹ä¸€è¦§</h2>
        <p>5ã¤ã®ã‚µã‚¤ã‚³ãƒ­ã‚’æœ€å¤§3å›æŒ¯ã£ã¦ã€ã‚ˆã‚Šå¼·ã„å½¹ã‚’ä½œã£ãŸæ–¹ã®å‹ã¡ã§ã™ã€‚<br>
        æ®‹ã—ãŸã„ã‚µã‚¤ã‚³ãƒ­ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€ŒHOLDã€ã—ã€å½¹ã‚’æƒãˆã¾ã—ã‚‡ã†ã€‚</p>
        
        <h3>ğŸ† å½¹ã®å¼·ã• (ä¸Šã»ã©å¼·ã„)</h3>
        <div class="hand-list">
            <span class="hand-rank">1. Five of a Kind (5ã‚«ãƒ¼ãƒ‰)</span><br>åŒã˜æ•°å­—ãŒ5ã¤ (ä¾‹: 77777)<br><br>
            <span class="hand-rank">2. Four of a Kind (4ã‚«ãƒ¼ãƒ‰)</span><br>åŒã˜æ•°å­—ãŒ4ã¤ (ä¾‹: 55551)<br><br>
            <span class="hand-rank">3. Full House (ãƒ•ãƒ«ãƒã‚¦ã‚¹)</span><br>3ã‚«ãƒ¼ãƒ‰ + 1ãƒšã‚¢ (ä¾‹: 33366)<br><br>
            <span class="hand-rank">4. Straight (ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ)</span><br>12345 ã¾ãŸã¯ 23456 ã®ä¸¦ã³<br><br>
            <span class="hand-rank">5. Three of a Kind (3ã‚«ãƒ¼ãƒ‰)</span><br>åŒã˜æ•°å­—ãŒ3ã¤ (ä¾‹: 22214)<br><br>
            <span class="hand-rank">6. Two Pair (2ãƒšã‚¢)</span><br>ãƒšã‚¢ãŒ2çµ„ (ä¾‹: 11445)<br><br>
            <span class="hand-rank">7. One Pair (1ãƒšã‚¢)</span><br>ãƒšã‚¢ãŒ1çµ„ (ä¾‹: 66123)<br><br>
            <span class="hand-rank">8. High Card (ãƒ–ã‚¿)</span><br>å½¹ãªã—ã€‚æ•°å­—ã®åˆè¨ˆãªã©ã¯é–¢ä¿‚ãªã—ã€‚
        </div>
        <br>
        <button class="btn btn-green" onclick="toggleRuleModal(false)">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    // â–¼â–¼â–¼â–¼â–¼ User Configuration â–¼â–¼â–¼â–¼â–¼
    const firebaseConfig = {
      apiKey: "AIzaSyD0micFDoWAHMpZdY2IPhjW3v2XLqloJX8",
      authDomain: "dice-poker-e9021.firebaseapp.com",
      databaseURL: "https://dice-poker-e9021-default-rtdb.firebaseio.com",
      projectId: "dice-poker-e9021",
      storageBucket: "dice-poker-e9021.firebasestorage.app",
      messagingSenderId: "730416248000",
      appId: "1:730416248000:web:349072ce1b17bcc139e925",
      measurementId: "G-KP58T1CMFN"
    };
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Settings
    const BET_GOLD = 100;
    const CPU_BETS = { 1: 20, 2: 50, 3: 100 };

    let myName = "Guest";
    let myGold = 1000;
    let mySilver = 500;
    
    let gameMode = null; 
    let cpuLevel = 2;
    let currentCpuBet = 50;

    let roomId = null;
    let myRole = null; 
    
    let myDice = [1,1,1,1,1];
    let opDice = [1,1,1,1,1];
    let heldDice = [false,false,false,false,false];
    let rollCount = 3;
    let isGameFinished = false;

    // DOM Elements
    const lobbyScreen = document.getElementById('lobby-screen');
    const gameScreen = document.getElementById('game-screen');
    const myDiceDiv = document.getElementById('my-dice-area');
    const opDiceDiv = document.getElementById('op-dice-area');
    const rollBtn = document.getElementById('roll-btn');
    const resultMsg = document.getElementById('result-msg');
    const actionArea = document.getElementById('action-area');
    const opStatus = document.getElementById('op-status');
    const myStatus = document.getElementById('my-status');
    const cpuCostDisplay = document.getElementById('cpu-cost-display');
    const nameInput = document.getElementById('player-name-input');
    const cancelWaitArea = document.getElementById('cancel-wait-area');
    const opNameDisp = document.getElementById('op-name-display');
    const opGoldDisp = document.getElementById('op-gold-display');

    loadWallet();
    updateCpuCost();

    function loadWallet() {
        myGold = parseInt(localStorage.getItem('dp_gold') || 1000);
        mySilver = parseInt(localStorage.getItem('dp_silver') || 500);
        myName = localStorage.getItem('dp_name') || "Player";
        nameInput.value = myName;
        updateWalletUI();
    }
    function saveWallet() {
        localStorage.setItem('dp_gold', myGold);
        localStorage.setItem('dp_silver', mySilver);
        updateWalletUI();
    }
    function saveName() {
        myName = nameInput.value || "Player";
        localStorage.setItem('dp_name', myName);
    }
    function updateWalletUI() {
        document.getElementById('disp-gold').innerText = myGold;
        document.getElementById('disp-silver').innerText = mySilver;
    }
    
    function resetSilver() {
        if(!confirm("CPUå¯¾æˆ¦ç”¨ã®ã‚³ã‚¤ãƒ³(Silver)ã‚’\nåˆæœŸå€¤(500)ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;
        mySilver = 500;
        saveWallet();
        updateWalletUI();
    }
    function resetGold() {
        if(!confirm("å¯¾äººæˆ¦ç”¨ã®ãƒãƒƒãƒ—(Gold)ã‚’\nåˆæœŸå€¤(1000)ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;
        myGold = 1000;
        saveWallet();
        updateWalletUI();
    }

    function toggleRuleModal(show) {
        document.getElementById('rule-modal').style.display = show ? 'flex' : 'none';
    }
    function updateCpuCost() {
        let lv = parseInt(document.getElementById('cpu-level').value);
        cpuCostDisplay.innerText = CPU_BETS[lv];
    }
    function backToLobby() {
        if(gameMode === 'multi' && roomId) {
            // åˆ‡æ–­å‡¦ç†ï¼šè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™
            db.ref(`rooms/${roomId}/${myRole}`).remove();
        }
        window.location.reload();
    }

    // --- 1. CPU Mode ---
    function startCpuGame() {
        saveName();
        cpuLevel = parseInt(document.getElementById('cpu-level').value);
        currentCpuBet = CPU_BETS[cpuLevel];

        if(mySilver < currentCpuBet) return alert("Silverã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        
        mySilver -= currentCpuBet;
        saveWallet();

        gameMode = 'cpu';
        document.getElementById('game-info').innerText = `Mode: CPU Battle (Lv.${cpuLevel}) Bet:${currentCpuBet}`;
        
        startGameCommon();
        
        opNameDisp.innerText = "CPU (Level " + cpuLevel + ")";
        opGoldDisp.innerText = "";
        document.getElementById('cpu-actions').style.display = 'flex';
        document.getElementById('multi-actions').style.display = 'none';
        document.getElementById('replay-cost').innerText = currentCpuBet;
        cancelWaitArea.style.display = 'none';

        opStatus.innerText = "æ€è€ƒä¸­...";
        updateOpDiceVisuals([0,0,0,0,0], false);
    }

    function restartCpuGame() {
        if(mySilver < currentCpuBet) return alert("Silverã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        mySilver -= currentCpuBet;
        saveWallet();
        
        startGameCommon();
        opStatus.innerText = "æ€è€ƒä¸­...";
        updateOpDiceVisuals([0,0,0,0,0], false);
    }

    // --- 2. Multiplayer Mode ---
    function setupMultiplayer(type) {
        saveName();
        if(myGold < BET_GOLD) return alert("Goldãƒãƒƒãƒ—ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        gameMode = 'multi';
        
        if(type === 'host') {
            roomId = Math.floor(1000 + Math.random()*9000).toString();
            myRole = 'host';
            initMultiDB();
        } else {
            roomId = document.getElementById('room-id-input').value;
            if(!roomId) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            myRole = 'guest';
            initMultiDB();
        }
    }

    function initMultiDB() {
        let playerData = { 
            dice: [0,0,0,0,0], 
            status: 'Thinking', 
            name: myName, 
            gold: myGold 
        };

        if(myRole === 'host') {
            // ãƒ›ã‚¹ãƒˆã¯éƒ¨å±‹è‡ªä½“ã‚’ä½œæˆ
            let updates = {
                host: playerData,
                guest: null // ã‚²ã‚¹ãƒˆã¯ã¾ã ã„ãªã„
            };
            db.ref('rooms/' + roomId).set(updates).then(onMultiReady);
        } else {
            // ã‚²ã‚¹ãƒˆã¯éƒ¨å±‹ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ã‹ã‚‰å…¥å®¤
            db.ref('rooms/' + roomId).once('value', snapshot => {
                if (!snapshot.exists()) {
                    alert("ãã®éƒ¨å±‹IDã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                    window.location.reload();
                    return;
                }
                // éƒ¨å±‹ãŒã‚ã‚Œã°è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€
                db.ref(`rooms/${roomId}/guest`).set(playerData).then(onMultiReady);
            });
        }
    }

    function onMultiReady() {
        myGold -= BET_GOLD;
        saveWallet();
        document.getElementById('game-info').innerText = "Mode: Online (Room " + roomId + ")";
        document.getElementById('room-id-display').innerText = roomId;
        
        startGameCommon();
        
        document.getElementById('cpu-actions').style.display = 'none';
        document.getElementById('multi-actions').style.display = 'flex';
        
        if(myRole === 'host') {
            cancelWaitArea.style.display = 'block';
        } else {
            cancelWaitArea.style.display = 'none';
        }

        listenToRoom();
    }

    function cancelHost() {
        if(!confirm("éƒ¨å±‹ã‚’è§£æ•£ã—ã¦ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ\n(å‚åŠ è²»ã¯è¿”é‡‘ã•ã‚Œã¾ã™)")) return;
        
        db.ref('rooms/' + roomId).remove(); // éƒ¨å±‹ã”ã¨å‰Šé™¤
        myGold += BET_GOLD;
        saveWallet();
        window.location.reload();
    }

    function restartMultiGame() {
        if(myGold < BET_GOLD) return alert("Goldãƒãƒƒãƒ—ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        
        myGold -= BET_GOLD;
        saveWallet();

        // ç”»é¢ã‚’ãƒªã‚»ãƒƒãƒˆ
        startGameCommon();
        
        // Hostã‚‚Guestã‚‚ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ã€ã¯å‡ºã•ãªã„ï¼ˆæ—¢ã«æ¥ç¶šæ¸ˆã¿ã ã‹ã‚‰ï¼‰
        cancelWaitArea.style.display = 'none';

        // Firebaseä¸Šã®è‡ªåˆ†ã®çŠ¶æ…‹ã‚’ã€ŒThinkingã€ã«æˆ»ã™
        db.ref(`rooms/${roomId}/${myRole}`).update({
            dice: [0,0,0,0,0],
            status: 'Thinking',
            name: myName,
            gold: myGold
        });
    }

    // éƒ¨å±‹ã®çŠ¶æ…‹ã‚’ç›£è¦–ï¼ˆã“ã“ãŒä¸€ç•ªå¤§äº‹ãªåŒæœŸå‡¦ç†ï¼ï¼‰
    function listenToRoom() {
        db.ref('rooms/' + roomId).on('value', snap => {
            const data = snap.val();
            // éƒ¨å±‹ãŒæ¶ˆã•ã‚ŒãŸå ´åˆ
            if(!data) {
                if(!isGameFinished && gameMode === 'multi') {
                    alert("éƒ¨å±‹ãŒè§£æ•£ã•ã‚Œã¾ã—ãŸã€‚ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚");
                    window.location.reload();
                }
                return;
            }

            let opRole = (myRole === 'host') ? 'guest' : 'host';
            let opData = data[opRole];

            if(opData) {
                // ç›¸æ‰‹ãŒã„ã‚‹
                if(myRole === 'host') cancelWaitArea.style.display = 'none';

                opNameDisp.innerText = opData.name || "Unknown";
                opGoldDisp.innerText = "ğŸ’°" + (opData.gold || 0);
                opStatus.innerText = opData.status;

                // ç›¸æ‰‹ãŒã€Œç¢ºå®šã€ã—ã¦ã„ã‚‹å ´åˆã€ã‚µã‚¤ã‚³ãƒ­ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹
                if(opData.status === "ç¢ºå®šï¼") opDice = opData.dice;

                // ä¸¡è€…ã€Œç¢ºå®šã€ã§ã€ã¾ã å‹è² ãŒã¤ã„ã¦ãªã‘ã‚Œã°æ±ºç€
                if(rollCount === 0 && opData.status === "ç¢ºå®šï¼" && !isGameFinished) {
                    updateOpDiceVisuals(opDice, true);
                    finishGame(myDice, opDice);
                } else if (!isGameFinished) {
                    // ã¾ã å‹è² ä¸­ãªã‚‰ã€ç›¸æ‰‹ã®ã‚µã‚¤ã‚³ãƒ­ã¯éš ã™
                    updateOpDiceVisuals(opData.dice || [0,0,0,0,0], false);
                }
            } else {
                // ç›¸æ‰‹ãŒã¾ã ã„ãªã„ã€ã¾ãŸã¯æŠœã‘ãŸ
                opNameDisp.innerText = "Waiting...";
                opGoldDisp.innerText = "";
                opStatus.innerText = "å¯¾æˆ¦ç›¸æ‰‹å¾…ã¡...";
                updateOpDiceVisuals([0,0,0,0,0], false);
                
                // ã‚‚ã—è‡ªåˆ†ãŒHostãªã‚‰å¾…æ©Ÿç”»é¢ã‚’å‡ºã™
                if(myRole === 'host' && !isGameFinished) cancelWaitArea.style.display = 'block';
            }
        });
    }

    // --- Common Game Logic ---
    function startGameCommon() {
        lobbyScreen.classList.remove('active');
        gameScreen.classList.add('active');
        
        rollCount = 3;
        heldDice = [false,false,false,false,false];
        isGameFinished = false;
        resultMsg.innerText = "";
        actionArea.style.display = 'none';
        
        rollBtn.disabled = false;
        rollBtn.innerText = "ROLL (3å›)";
        rollBtn.className = "btn btn-green";
        myStatus.innerText = "è€ƒãˆä¸­...";
        
        document.getElementById('op-hand-name').innerText = "";
        document.getElementById('my-hand-name').innerText = "";
        
        initMyDiceUI();
    }

    function initMyDiceUI() {
        myDiceDiv.innerHTML = '';
        for(let i=0; i<5; i++){
            let d = document.createElement('div');
            d.className = 'die';
            d.innerText = '-';
            d.onclick = () => toggleHold(i, d);
            myDiceDiv.appendChild(d);
        }
    }

    function toggleHold(i, el) {
        if(rollCount <= 0 || rollCount === 3 || isGameFinished) return;
        heldDice[i] = !heldDice[i];
        if(heldDice[i]) el.classList.add('held'); else el.classList.remove('held');
    }

    function rollAction() {
        if(rollCount <= 0) return;
        
        for(let i=0; i<5; i++){
            if(!heldDice[i]) myDice[i] = Math.floor(Math.random()*6)+1;
        }
        rollCount--;
        
        let dies = myDiceDiv.children;
        for(let i=0; i<5; i++) dies[i].innerText = myDice[i];
        
        if(rollCount < 3) {
            document.getElementById('my-hand-name').innerText = getHand(myDice).name;
        }

        let statusText = (rollCount === 0) ? "ç¢ºå®šï¼" : "è€ƒãˆä¸­...";
        myStatus.innerText = statusText;

        rollBtn.innerText = (rollCount > 0) ? `REROLL (ã‚ã¨${rollCount}å›)` : "å‹è² å¾…ã¡...";
        if(rollCount === 0) {
            rollBtn.disabled = true;
            rollBtn.className = "btn btn-gray";
        }

        if(gameMode === 'multi') {
            // Firebaseã«è‡ªåˆ†ã®çŠ¶æ…‹ã‚’é€ã‚‹
            db.ref(`rooms/${roomId}/${myRole}`).update({ 
                dice: myDice, 
                status: statusText,
                gold: myGold 
            });
        } else {
            runCpuProcess();
        }
    }

    function runCpuProcess() {
        if(isGameFinished) return;
        if(rollCount === 0) {
            opStatus.innerText = "æ¼”ç®—ä¸­...";
            setTimeout(() => {
                let cpuD = [0,0,0,0,0];
                let cpuHeld = [false,false,false,false,false];
                for(let turn=0; turn<3; turn++) {
                    for(let i=0; i<5; i++) { if(!cpuHeld[i]) cpuD[i] = Math.floor(Math.random()*6)+1; }
                    if(turn < 2) cpuHeld = decideCpuHold(cpuD, cpuLevel);
                }
                opDice = cpuD;
                updateOpDiceVisuals(opDice, true);
                opStatus.innerText = "ç¢ºå®šï¼";
                finishGame(myDice, opDice);
            }, 800);
        } else {
            opStatus.innerText = "ç›¸æ‰‹ã‚‚è€ƒãˆä¸­...";
        }
    }

    function decideCpuHold(dice, level) {
        let held = [false,false,false,false,false];
        let counts = {};
        dice.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
        
        if(level === 1) { // Easy
            dice.forEach((val, i) => { if(val === 6 || Math.random() > 0.7) held[i] = true; });
        }
        else if (level === 2) { // Normal
            dice.forEach((val, i) => { if(counts[val] >= 2) held[i] = true; });
        }
        else { // Hard
            let maxCount = Math.max(...Object.values(counts));
            if(maxCount >= 2) {
                dice.forEach((val, i) => { if(counts[val] >= 2) held[i] = true; });
            } else {
                dice.forEach((val, i) => { if(val >= 4) held[i] = true; });
            }
        }
        return held;
    }

    function updateOpDiceVisuals(dice, visible) {
        opDiceDiv.innerHTML = '';
        dice.forEach(val => {
            let d = document.createElement('div');
            d.className = 'die cpu';
            d.innerText = visible ? val : "?";
            if(visible) d.style.background = "white";
            opDiceDiv.appendChild(d);
        });
    }

    function finishGame(myD, opD) {
        isGameFinished = true;
        let myHand = getHand(myD);
        let opHand = getHand(opD);

        document.getElementById('my-hand-name').innerText = myHand.name;
        document.getElementById('op-hand-name').innerText = opHand.name;

        let isWin = false;
        
        if(myHand.rank > opHand.rank || (myHand.rank === opHand.rank && myHand.sum > opHand.sum)) {
            isWin = true;
            resultMsg.innerText = "ğŸ† YOU WIN!!";
            resultMsg.style.color = "#f1c40f";
        } else if (myHand.rank < opHand.rank || (myHand.rank === opHand.rank && myHand.sum < opHand.sum)) {
            resultMsg.innerText = "ğŸ’€ YOU LOSE...";
            resultMsg.style.color = "#e74c3c";
        } else {
            resultMsg.innerText = "ğŸ¤ DRAW";
            resultMsg.style.color = "white";
        }

        if(gameMode === 'cpu') {
            if(isWin) {
                let bonus = (cpuLevel - 1) * 20; 
                let reward = (currentCpuBet * 2) + bonus;
                mySilver += reward;
                resultMsg.innerText += ` (+${reward - currentCpuBet} Silver)`;
            } else if (resultMsg.innerText.includes("DRAW")) {
                mySilver += currentCpuBet;
            }
        } else {
            if(isWin) {
                myGold += (BET_GOLD * 2);
                resultMsg.innerText += ` (+${BET_GOLD} Gold)`;
            } else if (resultMsg.innerText.includes("DRAW")) {
                myGold += BET_GOLD;
            }
        }
        
        saveWallet();
        actionArea.style.display = 'block';
    }

    function getHand(dice) {
        if(!dice || dice.includes(0)) return {rank:0, name:"---", sum:0};
        let counts = {};
        let sum = 0;
        dice.forEach(x => { counts[x] = (counts[x] || 0) + 1; sum += x; });
        let values = Object.values(counts).sort((a,b) => b - a);
        let uniqueDice = [...new Set(dice)].sort().join('');
        let isStraight = (uniqueDice === '12345' || uniqueDice === '23456');

        if (values[0] === 5) return { rank: 8, name: "Five of a Kind", sum };
        if (values[0] === 4) return { rank: 7, name: "Four of a Kind", sum };
        if (values[0] === 3 && values[1] === 2) return { rank: 6, name: "Full House", sum };
        if (isStraight) return { rank: 5, name: "Straight", sum };
        if (values[0] === 3) return { rank: 4, name: "Three of a Kind", sum };
        if (values[0] === 2 && values[1] === 2) return { rank: 3, name: "Two Pair", sum };
        if (values[0] === 2) return { rank: 2, name: "One Pair", sum };
        return { rank: 1, name: "High Card", sum };
    }
</script>
</body>
</html>
