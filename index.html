<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Dice Poker</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { background-color: #2c3e50; color: white; font-family: sans-serif; text-align: center; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding-bottom: 50px; }
        .container { max-width: 800px; width: 95%; padding: 20px; }
        .btn { padding: 10px 20px; border-radius: 5px; border: none; font-size: 1rem; cursor: pointer; margin: 5px; font-weight: bold; }
        .btn-green { background-color: #27ae60; color: white; }
        .btn-blue { background-color: #2980b9; color: white; }
        
        .action-area { display: none; margin-top: 20px; gap: 10px; justify-content: center; }
        .btn-rematch { background-color: #e74c3c; color: white; flex: 1; padding: 15px; font-size: 1.1rem; box-shadow: 0 4px 0 #c0392b; }
        .btn-rematch:active { transform: translateY(4px); box-shadow: none; }
        .btn-lobby { background-color: #95a5a6; color: white; flex: 1; padding: 15px; font-size: 1.1rem; box-shadow: 0 4px 0 #7f8c8d; }
        .btn-lobby:active { transform: translateY(4px); box-shadow: none; }

        input { padding: 10px; font-size: 1rem; text-align: center; border-radius: 5px; border: 1px solid #ccc; width: 80%; max-width: 300px; margin-bottom: 10px; }
        
        /* è‡ªåˆ†ã‚¨ãƒªã‚¢ */
        .my-section { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; margin-top: 20px; }
        .dice-area { display: flex; justify-content: center; gap: 10px; margin: 20px 0; min-height: 60px; }
        .die { width: 50px; height: 50px; background: white; color: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border: 3px solid transparent; }
        .die.held { background: #f1c40f; border-color: #e67e22; transform: translateY(-5px); }
        
        /* ç›¸æ‰‹ã‚¨ãƒªã‚¢ */
        .opponents-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .opponent-card { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; width: 150px; text-align: center; position: relative; }
        .op-name { font-weight: bold; font-size: 0.9rem; color: #ecf0f1; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .op-dice-area { display: flex; justify-content: center; gap: 3px; margin-top: 5px; }
        .op-die { width: 22px; height: 22px; background: #bdc3c7; color: #333; border-radius: 3px; font-size: 14px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .status { margin: 15px; font-size: 1.2rem; color: #f39c12; }
        #setup-screen, #game-screen { display: none; }
        .active { display: block !important; }
        
        .room-display { background-color: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; display: inline-block; margin-bottom: 10px; border: 2px solid #f1c40f; color: #f1c40f; font-weight: bold; font-size: 1.2rem; }
        
        .chip-display { background-color: #f39c12; color: #2c3e50; padding: 10px 20px; border-radius: 50px; font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: inline-block; }
        
        #result-msg { font-size: 2rem; font-weight: bold; margin: 20px 0; min-height: 3rem; text-shadow: 2px 2px 0 #000; }
        .pot-display { color: #2ecc71; font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; }
        
        /* åå‰å…¥åŠ›ãƒ©ãƒ™ãƒ« */
        .input-label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #bdc3c7; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ² Online Dice Poker</h1>

    <div id="setup-screen" class="active">
        <div class="chip-display">æ‰€æŒé‡‘: $<span id="title-chips">---</span></div>
        <br>
        
        <label class="input-label">ã‚ãªãŸã®åå‰</label>
        <input type="text" id="player-name-input" placeholder="åå‰ã‚’å…¥åŠ› (ä¾‹: Kouki)">
        
        <br><br>
        <p>éƒ¨å±‹ã‚’ä½œã£ã¦å‹é”ã‚’æ‹›å¾…ã—ã‚ˆã†</p>
        <button class="btn btn-green" onclick="createRoom()">éƒ¨å±‹ã‚’ä½œã‚‹ (HOST)</button>
        <br><br>
        <p>ã¾ãŸã¯ã€éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦å‚åŠ </p>
        <input type="text" id="room-id-input" placeholder="éƒ¨å±‹IDã‚’å…¥åŠ›">
        <button class="btn btn-blue" onclick="joinRoom()">éƒ¨å±‹ã«å…¥ã‚‹ (JOIN)</button>
        <br><br>
        <button class="btn" style="background:#95a5a6; font-size:0.8rem;" onclick="resetChips()">ğŸ’¸ æ‰€æŒé‡‘ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="game-screen">
        <div class="chip-display">æ‰€æŒé‡‘: $<span id="game-chips">---</span></div>
        <br>
        <div id="game-room-display" class="room-display">ID: ----</div>
        <div id="pot-display" class="pot-display">POT: $0</div>
        
        <div id="result-msg"></div>

        <div id="opponents-container" class="opponents-container">
            </div>

        <hr style="opacity:0.3; margin: 20px 0;">
        
        <div class="my-section">
            <div id="my-name-display" style="font-weight:bold; font-size:1.2rem; color:#ecf0f1;">YOU</div>
            <div class="status"><span id="my-status">æº–å‚™ä¸­</span></div>
            <div class="dice-area" id="my-dice"></div>
            <div id="my-hand-name" style="font-size:0.9rem; color:#f1c40f; font-weight:bold;"></div>
            
            <button id="roll-btn" class="btn btn-green" onclick="rollAction()">ROLL (3å›)</button>
        </div>

        <div id="action-buttons" class="action-area">
            <button class="btn btn-rematch" onclick="resetGame()">ğŸ”¥ ã‚‚ã†ä¸€åº¦ã‚„ã‚‹</button>
            <button class="btn btn-lobby" onclick="exitToLobby()">ğŸ  ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
        </div>
        
        <p id="msg">ã‚¯ãƒªãƒƒã‚¯ã—ã¦HOLD / ROLLã§ç¢ºå®š</p>
    </div>
</div>

<script>
    // â–¼â–¼â–¼â–¼â–¼ ã“ã“ã ã‘è‡ªåˆ†ã®è¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼â–¼â–¼
    const firebaseConfig = {
      apiKey: "AIzaSyD0micFDoWAHMpZdY2IPhjW3v2XLqloJX8",
      authDomain: "dice-poker-e9021.firebaseapp.com",
      databaseURL: "https://dice-poker-e9021-default-rtdb.firebaseio.com",
      projectId: "dice-poker-e9021",
      storageBucket: "dice-poker-e9021.firebasestorage.app",
      messagingSenderId: "730416248000",
      appId: "1:730416248000:web:349072ce1b17bcc139e925",
      measurementId: "G-KP58T1CMFN"
    };

    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let roomId = null;
    let myId = null;
    let myName = "Player";
    let myDice = [1,1,1,1,1];
    let heldDice = [false,false,false,false,false];
    let rollCount = 3;
    let isGameFinished = false;
    let lastResetTime = 0;
    
    let myChips = 1000;
    const BET_AMOUNT = 100;

    // DOMè¦ç´ 
    const setupScreen = document.getElementById('setup-screen');
    const gameScreen = document.getElementById('game-screen');
    const myDiceDiv = document.getElementById('my-dice');
    const opponentsDiv = document.getElementById('opponents-container');
    const roomDisplay = document.getElementById('game-room-display');
    const resultMsg = document.getElementById('result-msg');
    const actionButtons = document.getElementById('action-buttons');
    const titleChips = document.getElementById('title-chips');
    const gameChips = document.getElementById('game-chips');
    const potDisplay = document.getElementById('pot-display');
    const nameInput = document.getElementById('player-name-input');
    const myNameDisplay = document.getElementById('my-name-display');

    // åˆæœŸåŒ–
    loadSettings();
    myId = 'player_' + Math.floor(Math.random() * 1000000);

    function loadSettings() {
        // ãƒãƒƒãƒ—èª­ã¿è¾¼ã¿
        const savedChips = localStorage.getItem('dicePokerChips');
        myChips = savedChips ? parseInt(savedChips) : 1000;
        updateChipDisplay();
        
        // åå‰èª­ã¿è¾¼ã¿
        const savedName = localStorage.getItem('dicePokerName');
        if(savedName) {
            nameInput.value = savedName;
            myName = savedName;
        }
    }

    function saveSettings() {
        localStorage.setItem('dicePokerChips', myChips);
        myName = nameInput.value || "No Name";
        localStorage.setItem('dicePokerName', myName);
        updateChipDisplay();
    }
    
    function resetChips() {
        if(confirm("æœ¬å½“ã«æ‰€æŒé‡‘ã‚’$1000ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
            myChips = 1000;
            saveSettings();
        }
    }

    function updateChipDisplay() {
        titleChips.innerText = myChips;
        gameChips.innerText = myChips;
    }

    function createRoom() {
        if(myChips < BET_AMOUNT) return alert("ãƒãƒƒãƒ—ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        saveSettings(); // åå‰ä¿å­˜
        roomId = Math.floor(1000 + Math.random() * 9000).toString();
        
        let initialData = {
            resetSignal: Date.now(),
            players: {}
        };
        db.ref('rooms/' + roomId).set(initialData).then(() => {
            joinGameProcess();
        });
    }

    function joinRoom() {
        if(myChips < BET_AMOUNT) return alert("ãƒãƒƒãƒ—ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        roomId = document.getElementById('room-id-input').value;
        if (!roomId) return alert("éƒ¨å±‹IDã‚’å…¥ã‚Œã¦ã­");
        saveSettings(); // åå‰ä¿å­˜
        joinGameProcess();
    }

    function joinGameProcess() {
        const playerRef = db.ref(`rooms/${roomId}/players/${myId}`);
        
        // 1. DBã«è‡ªåˆ†ã‚’ç™»éŒ²
        playerRef.set({
            dice: [0,0,0,0,0],
            status: 'Thinking',
            chips: myChips,
            name: myName
        });

        // 2. ã€é‡è¦ã€‘åˆ‡æ–­æ™‚ã«è‡ªå‹•ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™è¨­å®š
        playerRef.onDisconnect().remove();
        
        roomDisplay.innerText = "ID: " + roomId;
        myNameDisplay.innerText = myName + " (ã‚ãªãŸ)";
        
        setupScreen.classList.remove('active');
        gameScreen.classList.add('active');
        
        listenToRoom();
        startGameUI();
    }

    function resetGame() {
        if(myChips < BET_AMOUNT) {
            alert("ç ´ç”£ã—ã¾ã—ãŸ...");
            exitToLobby();
            return;
        }
        db.ref('rooms/' + roomId).update({
            resetSignal: Date.now()
        });
    }

    function exitToLobby() {
        // é€€å‡ºæ™‚ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦ã‹ã‚‰ãƒªãƒ­ãƒ¼ãƒ‰
        db.ref(`rooms/${roomId}/players/${myId}`).remove().then(() => {
            window.location.reload();
        });
    }

    function startGameUI() {
        rollCount = 3;
        heldDice = [false,false,false,false,false];
        isGameFinished = false;
        resultMsg.innerText = "";
        actionButtons.style.display = "none";
        
        document.getElementById('roll-btn').disabled = false;
        document.getElementById('roll-btn').style.backgroundColor = "#27ae60";
        document.getElementById('roll-btn').innerText = "ROLL (3å›)";
        document.getElementById('my-hand-name').innerText = "";
        
        initMyDice();
        updateMyStatus("è€ƒãˆä¸­...");
    }

    function initMyDice() {
        myDiceDiv.innerHTML = '';
        for(let i=0; i<5; i++){
            let d = document.createElement('div');
            d.className = 'die';
            d.innerText = '-';
            d.onclick = () => toggleHold(i, d);
            myDiceDiv.appendChild(d);
        }
    }

    function toggleHold(i, el) {
        if(rollCount <= 0 || rollCount === 3 || isGameFinished) return;
        heldDice[i] = !heldDice[i];
        if(heldDice[i]) el.classList.add('held'); else el.classList.remove('held');
    }

    function rollAction() {
        if(rollCount <= 0) return;
        for(let i=0; i<5; i++){
            if(!heldDice[i]) myDice[i] = Math.floor(Math.random()*6)+1;
        }
        rollCount--;
        
        let dies = myDiceDiv.children;
        for(let i=0; i<5; i++) dies[i].innerText = myDice[i];
        if(rollCount < 3) document.getElementById('my-hand-name').innerText = getHandName(myDice).name;

        let statusText = (rollCount === 0) ? "ç¢ºå®šï¼" : "è€ƒãˆä¸­...";
        updateMyStatus(statusText);

        document.getElementById('roll-btn').innerText = (rollCount > 0) ? `REROLL (ã‚ã¨${rollCount}å›)` : "å‹è² å¾…ã¡...";
        if(rollCount === 0) {
            document.getElementById('roll-btn').disabled = true;
            document.getElementById('roll-btn').style.backgroundColor = "#7f8c8d";
        }
    }

    function updateMyStatus(status) {
        db.ref(`rooms/${roomId}/players/${myId}`).update({
            dice: myDice,
            status: status,
            chips: myChips,
            name: myName
        });
    }

    function listenToRoom() {
        db.ref('rooms/' + roomId).on('value', (snapshot) => {
            const data = snapshot.val();
            // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¦ã„ã‚‹å ´åˆã®å¯¾ç­–
            if (!data) return;

            // ãƒªã‚»ãƒƒãƒˆç›£è¦–
            if (data.resetSignal && data.resetSignal > lastResetTime) {
                lastResetTime = data.resetSignal;
                startGameUI();
                return;
            }

            const players = data.players || {};
            const playerKeys = Object.keys(players);
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè‡ªåˆ†ã—ã‹ã„ãªã„å ´åˆ
            if (playerKeys.length <= 1) {
                opponentsDiv.innerHTML = '<div style="color:#bdc3c7;">å¯¾æˆ¦ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>';
                potDisplay.innerText = "POT: ---";
                return; // ä¸€äººãªã‚‰å‹æ•—åˆ¤å®šã‚‚ã—ãªã„
            }

            potDisplay.innerText = `POT: $${playerKeys.length * BET_AMOUNT}`;

            // ç›¸æ‰‹ã‚¨ãƒªã‚¢æç”»
            opponentsDiv.innerHTML = '';
            let allFinished = true;

            playerKeys.forEach(key => {
                if (key === myId) return; // è‡ªåˆ†ã¯ã‚¹ã‚­ãƒƒãƒ—
                
                let p = players[key];
                if (!p) return; // ãƒ‡ãƒ¼ã‚¿ç ´æå¯¾ç­–

                if (p.status !== "ç¢ºå®šï¼") allFinished = false;

                let card = document.createElement('div');
                card.className = 'opponent-card';
                
                // åå‰è¡¨ç¤º
                let nameHtml = `<div class="op-name">${p.name || 'Unknown'}</div>`;
                let chipText = `<div style="font-size:0.8rem;">$${p.chips}</div>`;
                let statusText = `<div style="color:${p.status==='ç¢ºå®šï¼'?'#2ecc71':'#f1c40f'}">${p.status}</div>`;
                
                let diceHtml = '<div class="op-dice-area">';
                if (p.dice) {
                    p.dice.forEach(val => {
                        let show = isGameFinished; 
                        diceHtml += `<div class="op-die" style="background:${show ? '#bdc3c7':'#7f8c8d'}">${show ? val : '?'}</div>`;
                    });
                }
                diceHtml += '</div>';
                
                let handName = isGameFinished ? `<div style="font-size:0.7rem; color:#bdc3c7; margin-top:5px;">${getHandName(p.dice).name}</div>` : '';

                card.innerHTML = nameHtml + chipText + statusText + diceHtml + handName;
                opponentsDiv.appendChild(card);
            });

            // è‡ªåˆ†ã®çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
            let myData = players[myId];
            if (!myData || myData.status !== "ç¢ºå®šï¼") allFinished = false;

            // å‹æ•—åˆ¤å®š
            if (allFinished && !isGameFinished) {
                isGameFinished = true;
                determineWinner(players);
            }
        });
    }

    function determineWinner(players) {
        let results = [];
        Object.keys(players).forEach(key => {
            let p = players[key];
            if(!p) return;
            let hand = getHandName(p.dice);
            results.push({ id: key, name: p.name, rank: hand.rank, subRank: hand.subRank });
        });

        // ãƒ©ãƒ³ã‚¯é †ã«ã‚½ãƒ¼ãƒˆ
        results.sort((a, b) => b.rank - a.rank);

        let winner = results[0];
        let isMeWinner = (winner.id === myId);
        let isDraw = (results.length > 1 && results[1].rank === winner.rank);
        let pot = results.length * BET_AMOUNT;

        if (isDraw) {
            resultMsg.innerText = "DRAW (å¼•ãåˆ†ã‘) Â±0";
            resultMsg.style.color = "#fff";
        } else if (isMeWinner) {
            let profit = (results.length - 1) * BET_AMOUNT;
            resultMsg.innerText = `WIN!! (+$${profit}) ğŸ†`;
            resultMsg.style.color = "#f1c40f";
            myChips += profit;
        } else {
            resultMsg.innerText = `LOSE... (-$${BET_AMOUNT}) ğŸ˜¢`;
            resultMsg.style.color = "#e74c3c";
            // å‹è€…ã®åå‰ã‚’è¡¨ç¤º
            let winnerName = isDraw ? "å¼•ãåˆ†ã‘" : winner.name;
            resultMsg.innerHTML += `<div style="font-size:1rem; color:#bdc3c7; margin-top:5px;">Winner: ${winnerName}</div>`;
            myChips -= BET_AMOUNT;
        }

        saveSettings(); // ãƒãƒƒãƒ—ä¿å­˜
        db.ref(`rooms/${roomId}/players/${myId}/chips`).set(myChips);
        
        // ç¢ºå®šçŠ¶æ…‹ã‚’å†é€ä¿¡ï¼ˆç›¸æ‰‹ã«æ‰‹æœ­ã‚’è¦‹ã›ã‚‹ãŸã‚ï¼‰
        updateMyStatus("ç¢ºå®šï¼");
        actionButtons.style.display = "flex";
    }

    function getHandName(dice) {
        if(!dice) return {rank:0, name:""};
        let counts = {};
        dice.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
        let values = Object.values(counts).sort((a,b) => b - a);
        let uniqueDice = [...new Set(dice)].sort().join('');
        let isStraight = (uniqueDice === '12345' || uniqueDice === '23456');

        if (values[0] === 5) return { rank: 8, name: "5ã‚«ãƒ¼ãƒ‰" };
        if (values[0] === 4) return { rank: 7, name: "4ã‚«ãƒ¼ãƒ‰" };
        if (values[0] === 3 && values[1] === 2) return { rank: 6, name: "ãƒ•ãƒ«ãƒã‚¦ã‚¹" };
        if (isStraight) return { rank: 5, name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ" };
        if (values[0] === 3) return { rank: 4, name: "3ã‚«ãƒ¼ãƒ‰" };
        if (values[0] === 2 && values[1] === 2) return { rank: 3, name: "2ãƒšã‚¢" };
        if (values[0] === 2) return { rank: 2, name: "1ãƒšã‚¢" };
        return { rank: 1, name: "ãƒ–ã‚¿" };
    }
</script>
</body>
</html>
