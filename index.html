<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Dice Poker (Multiplayer)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { background-color: #2c3e50; color: white; font-family: sans-serif; text-align: center; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding-bottom: 50px; }
        .container { max-width: 800px; width: 95%; padding: 20px; } /* å°‘ã—åºƒã’ãŸ */
        .btn { padding: 10px 20px; border-radius: 5px; border: none; font-size: 1rem; cursor: pointer; margin: 5px; font-weight: bold; }
        .btn-green { background-color: #27ae60; color: white; }
        .btn-blue { background-color: #2980b9; color: white; }
        
        .action-area { display: none; margin-top: 20px; gap: 10px; justify-content: center; }
        .btn-rematch { background-color: #e74c3c; color: white; flex: 1; padding: 15px; font-size: 1.1rem; box-shadow: 0 4px 0 #c0392b; }
        .btn-rematch:active { transform: translateY(4px); box-shadow: none; }
        .btn-lobby { background-color: #95a5a6; color: white; flex: 1; padding: 15px; font-size: 1.1rem; box-shadow: 0 4px 0 #7f8c8d; }
        .btn-lobby:active { transform: translateY(4px); box-shadow: none; }

        input { padding: 10px; font-size: 1rem; text-align: center; }
        
        /* è‡ªåˆ†ç”¨ã®ãƒ€ã‚¤ã‚¹ã‚¨ãƒªã‚¢ */
        .my-section { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; margin-top: 20px; }
        .dice-area { display: flex; justify-content: center; gap: 10px; margin: 20px 0; min-height: 60px; }
        .die { width: 50px; height: 50px; background: white; color: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border: 3px solid transparent; }
        .die.held { background: #f1c40f; border-color: #e67e22; transform: translateY(-5px); }
        
        /* ç›¸æ‰‹ç”¨ã®å°ã•ã„ãƒ€ã‚¤ã‚¹ã‚¨ãƒªã‚¢ */
        .opponents-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .opponent-card { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; width: 140px; text-align: center; }
        .op-dice-area { display: flex; justify-content: center; gap: 2px; margin-top: 5px; }
        .op-die { width: 20px; height: 20px; background: #bdc3c7; color: #333; border-radius: 3px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .status { margin: 15px; font-size: 1.2rem; color: #f39c12; }
        #setup-screen, #game-screen { display: none; }
        .active { display: block !important; }
        
        .room-display { background-color: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; display: inline-block; margin-bottom: 10px; border: 2px solid #f1c40f; color: #f1c40f; font-weight: bold; font-size: 1.2rem; }
        
        .chip-display { background-color: #f39c12; color: #2c3e50; padding: 10px 20px; border-radius: 50px; font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: inline-block; }
        
        #result-msg { font-size: 2rem; font-weight: bold; margin: 20px 0; min-height: 3rem; text-shadow: 2px 2px 0 #000; }
        .pot-display { color: #2ecc71; font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ² Online Dice Poker <span style="font-size:0.5em">Multi</span></h1>

    <div id="setup-screen" class="active">
        <div class="chip-display">æ‰€æŒé‡‘: $<span id="title-chips">---</span></div>
        <br>
        <p>éƒ¨å±‹ã‚’ä½œã£ã¦å‹é”ã‚’æ‹›å¾…ã—ã‚ˆã†</p>
        <button class="btn btn-green" onclick="createRoom()">éƒ¨å±‹ã‚’ä½œã‚‹ (HOST)</button>
        <br><br>
        <p>ã¾ãŸã¯ã€éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦å‚åŠ </p>
        <input type="text" id="room-id-input" placeholder="éƒ¨å±‹IDã‚’å…¥åŠ›">
        <button class="btn btn-blue" onclick="joinRoom()">éƒ¨å±‹ã«å…¥ã‚‹ (JOIN)</button>
        <br><br>
        <button class="btn" style="background:#95a5a6; font-size:0.8rem;" onclick="resetChips()">ğŸ’¸ æ‰€æŒé‡‘ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="game-screen">
        <div class="chip-display">æ‰€æŒé‡‘: $<span id="game-chips">---</span></div>
        <br>
        <div id="game-room-display" class="room-display">ID: ----</div>
        <div id="pot-display" class="pot-display">POT: $0</div>
        
        <div id="result-msg"></div>

        <div id="opponents-container" class="opponents-container">
            </div>

        <hr style="opacity:0.3; margin: 20px 0;">
        
        <div class="my-section">
            <div class="status">ã‚ãªãŸ: <span id="my-status">æº–å‚™ä¸­</span></div>
            <div class="dice-area" id="my-dice"></div>
            <div id="my-hand-name" style="font-size:0.9rem; color:#f1c40f; font-weight:bold;"></div>
            
            <button id="roll-btn" class="btn btn-green" onclick="rollAction()">ROLL (3å›)</button>
        </div>

        <div id="action-buttons" class="action-area">
            <button class="btn btn-rematch" onclick="resetGame()">ğŸ”¥ ã‚‚ã†ä¸€åº¦ã‚„ã‚‹</button>
            <button class="btn btn-lobby" onclick="exitToLobby()">ğŸ  ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
        </div>
        
        <p id="msg">ã‚¯ãƒªãƒƒã‚¯ã—ã¦HOLD / ROLLã§ç¢ºå®š</p>
    </div>
</div>

<script>
    // â–¼â–¼â–¼â–¼â–¼ ã“ã“ã ã‘è‡ªåˆ†ã®è¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼â–¼â–¼
    const firebaseConfig = {
      apiKey: "AIzaSyD0micFDoWAHMpZdY2IPhjW3v2XLqloJX8",
      authDomain: "dice-poker-e9021.firebaseapp.com",
      databaseURL: "https://dice-poker-e9021-default-rtdb.firebaseio.com",
      projectId: "dice-poker-e9021",
      storageBucket: "dice-poker-e9021.firebasestorage.app",
      messagingSenderId: "730416248000",
      appId: "1:730416248000:web:349072ce1b17bcc139e925",
      measurementId: "G-KP58T1CMFN"
    };

    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let roomId = null;
    let myId = null; // è‡ªåˆ†ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
    let myDice = [1,1,1,1,1];
    let heldDice = [false,false,false,false,false];
    let rollCount = 3;
    let isGameFinished = false;
    let lastResetTime = 0;
    
    let myChips = 1000;
    const BET_AMOUNT = 100;

    // DOMè¦ç´ 
    const setupScreen = document.getElementById('setup-screen');
    const gameScreen = document.getElementById('game-screen');
    const myDiceDiv = document.getElementById('my-dice');
    const opponentsDiv = document.getElementById('opponents-container');
    const roomDisplay = document.getElementById('game-room-display');
    const resultMsg = document.getElementById('result-msg');
    const actionButtons = document.getElementById('action-buttons');
    const titleChips = document.getElementById('title-chips');
    const gameChips = document.getElementById('game-chips');
    const potDisplay = document.getElementById('pot-display');

    // åˆæœŸåŒ–
    loadChips();
    // è‡ªåˆ†ã®IDã‚’ç”Ÿæˆï¼ˆç°¡æ˜“çš„ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—+ä¹±æ•°ï¼‰
    myId = 'player_' + Math.floor(Math.random() * 100000);

    function loadChips() {
        const saved = localStorage.getItem('dicePokerChips');
        myChips = saved ? parseInt(saved) : 1000;
        updateChipDisplay();
    }
    function saveChips() {
        localStorage.setItem('dicePokerChips', myChips);
        updateChipDisplay();
    }
    function resetChips() {
        if(confirm("æœ¬å½“ã«æ‰€æŒé‡‘ã‚’$1000ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
            myChips = 1000;
            saveChips();
        }
    }
    function updateChipDisplay() {
        titleChips.innerText = myChips;
        gameChips.innerText = myChips;
    }

    // éƒ¨å±‹ä½œæˆ
    function createRoom() {
        if(myChips < BET_AMOUNT) return alert("ãƒãƒƒãƒ—ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        roomId = Math.floor(1000 + Math.random() * 9000).toString();
        // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ï¼ˆplayersãƒãƒ¼ãƒ‰ã‚’ä½œã‚‹ï¼‰
        let initialData = {
            resetSignal: Date.now(),
            players: {}
        };
        db.ref('rooms/' + roomId).set(initialData).then(() => {
            joinGameProcess();
        });
    }

    // éƒ¨å±‹å‚åŠ 
    function joinRoom() {
        if(myChips < BET_AMOUNT) return alert("ãƒãƒƒãƒ—ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        roomId = document.getElementById('room-id-input').value;
        if (!roomId) return alert("éƒ¨å±‹IDã‚’å…¥ã‚Œã¦ã­");
        joinGameProcess();
    }

    // ã‚²ãƒ¼ãƒ å‚åŠ å‡¦ç†ï¼ˆå…±é€šï¼‰
    function joinGameProcess() {
        // DBã«è‡ªåˆ†ã‚’ç™»éŒ²
        db.ref(`rooms/${roomId}/players/${myId}`).set({
            dice: [0,0,0,0,0],
            status: 'Thinking',
            chips: myChips,
            name: 'Player' // å°†æ¥çš„ã«åå‰æ©Ÿèƒ½ã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«
        });
        
        roomDisplay.innerText = "ID: " + roomId;
        setupScreen.classList.remove('active');
        gameScreen.classList.add('active');
        
        listenToRoom();
        startGameUI();
    }

    // ãƒªã‚»ãƒƒãƒˆï¼ˆå†æˆ¦ï¼‰
    function resetGame() {
        if(myChips < BET_AMOUNT) {
            alert("ç ´ç”£ã—ã¾ã—ãŸ...");
            exitToLobby();
            return;
        }
        // ãƒªã‚»ãƒƒãƒˆä¿¡å·ã‚’é€ã‚‹ï¼ˆå…¨å“¡ã«é€šçŸ¥ï¼‰
        db.ref('rooms/' + roomId).update({
            resetSignal: Date.now()
        });
    }

    function exitToLobby() {
        window.location.reload();
    }

    // ç”»é¢åˆæœŸåŒ–
    function startGameUI() {
        rollCount = 3;
        heldDice = [false,false,false,false,false];
        isGameFinished = false;
        resultMsg.innerText = "";
        actionButtons.style.display = "none";
        
        document.getElementById('roll-btn').disabled = false;
        document.getElementById('roll-btn').style.backgroundColor = "#27ae60";
        document.getElementById('roll-btn').innerText = "ROLL (3å›)";
        document.getElementById('my-hand-name').innerText = "";
        
        initMyDice();
        // çŠ¶æ…‹ã‚’DBã¸é€ä¿¡
        updateMyStatus("è€ƒãˆä¸­...");
    }

    function initMyDice() {
        myDiceDiv.innerHTML = '';
        for(let i=0; i<5; i++){
            let d = document.createElement('div');
            d.className = 'die';
            d.innerText = '-';
            d.onclick = () => toggleHold(i, d);
            myDiceDiv.appendChild(d);
        }
    }

    function toggleHold(i, el) {
        if(rollCount <= 0 || rollCount === 3 || isGameFinished) return;
        heldDice[i] = !heldDice[i];
        if(heldDice[i]) el.classList.add('held'); else el.classList.remove('held');
    }

    function rollAction() {
        if(rollCount <= 0) return;
        for(let i=0; i<5; i++){
            if(!heldDice[i]) myDice[i] = Math.floor(Math.random()*6)+1;
        }
        rollCount--;
        
        let dies = myDiceDiv.children;
        for(let i=0; i<5; i++) dies[i].innerText = myDice[i];
        if(rollCount < 3) document.getElementById('my-hand-name').innerText = getHandName(myDice).name;

        let statusText = (rollCount === 0) ? "ç¢ºå®šï¼" : "è€ƒãˆä¸­...";
        updateMyStatus(statusText);

        document.getElementById('roll-btn').innerText = (rollCount > 0) ? `REROLL (ã‚ã¨${rollCount}å›)` : "å‹è² å¾…ã¡...";
        if(rollCount === 0) {
            document.getElementById('roll-btn').disabled = true;
            document.getElementById('roll-btn').style.backgroundColor = "#7f8c8d";
        }
    }

    function updateMyStatus(status) {
        db.ref(`rooms/${roomId}/players/${myId}`).update({
            dice: myDice,
            status: status,
            chips: myChips
        });
    }

    // éƒ¨å±‹ã®ç›£è¦–ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    function listenToRoom() {
        db.ref('rooms/' + roomId).on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            // ãƒªã‚»ãƒƒãƒˆç›£è¦–
            if (data.resetSignal && data.resetSignal > lastResetTime) {
                lastResetTime = data.resetSignal;
                startGameUI();
                return;
            }

            const players = data.players || {};
            const playerList = Object.values(players);
            const myData = players[myId];
            
            // ãƒãƒƒãƒˆè¡¨ç¤ºï¼ˆå‚åŠ äººæ•° Ã— 100ï¼‰
            let playerCount = Object.keys(players).length;
            potDisplay.innerText = `POT: $${playerCount * BET_AMOUNT}`;

            // ç›¸æ‰‹ã‚¨ãƒªã‚¢ã®æç”»
            opponentsDiv.innerHTML = '';
            let allFinished = true;

            Object.keys(players).forEach(key => {
                if (key === myId) return; // è‡ªåˆ†ã¯ã‚¹ã‚­ãƒƒãƒ—
                
                let p = players[key];
                if (p.status !== "ç¢ºå®šï¼") allFinished = false;

                // ç›¸æ‰‹ã‚«ãƒ¼ãƒ‰ä½œæˆ
                let card = document.createElement('div');
                card.className = 'opponent-card';
                
                let chipText = `<div style="font-size:0.8rem;">$${p.chips}</div>`;
                let statusText = `<div style="color:${p.status==='ç¢ºå®šï¼'?'#2ecc71':'#f1c40f'}">${p.status}</div>`;
                
                let diceHtml = '<div class="op-dice-area">';
                if (p.dice) {
                    p.dice.forEach(val => {
                        // å‹è² ãŒã¤ã„ãŸã‹ã€ç¢ºå®šæ¸ˆã¿ãªã‚‰è¡¨ç¤ºï¼ˆä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ç¢ºå®šã—ãŸã‚‰è¦‹ã›ã‚‹ä»•æ§˜ã«ã™ã‚‹ã‹ã€éš ã™ã‹ï¼‰
                        // â†’ ä»¥å‰ã®ä»•æ§˜é€šã‚Šã€Œå‹è² ãŒã¤ãã¾ã§éš ã™ã€
                        let show = isGameFinished; 
                        diceHtml += `<div class="op-die" style="background:${show ? '#bdc3c7':'#7f8c8d'}">${show ? val : '?'}</div>`;
                    });
                }
                diceHtml += '</div>';
                
                // å‹è² ãŒã¤ã„ãŸå¾Œã¯å½¹åã‚‚å‡ºã™
                let handName = isGameFinished ? `<div style="font-size:0.7rem; color:#bdc3c7;">${getHandName(p.dice).name}</div>` : '';

                card.innerHTML = chipText + statusText + diceHtml + handName;
                opponentsDiv.appendChild(card);
            });

            // è‡ªåˆ†ã®çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
            if (!myData || myData.status !== "ç¢ºå®šï¼") allFinished = false;

            // å…¨å“¡ç¢ºå®šã—ãŸã‚‰å‹æ•—åˆ¤å®š
            if (allFinished && !isGameFinished) {
                isGameFinished = true;
                determineWinner(players);
            }
        });
    }

    function determineWinner(players) {
        // å…¨å“¡ã®æ‰‹å½¹ã‚’è¨ˆç®—ã—ã¦ãƒ©ãƒ³ã‚¯ä»˜ã‘
        let results = [];
        Object.keys(players).forEach(key => {
            let p = players[key];
            let hand = getHandName(p.dice);
            results.push({ id: key, rank: hand.rank, subRank: hand.subRank, chips: p.chips });
        });

        // ãƒ©ãƒ³ã‚¯ãŒé«˜ã„é †ã«ã‚½ãƒ¼ãƒˆï¼ˆåŒã˜ãƒ©ãƒ³ã‚¯ãªã‚‰ã‚µã‚¤ã‚³ãƒ­ã®æ•°å­—ã§æ¯”è¼ƒâ€¦ã¯ç°¡æ˜“ç‰ˆãªã®ã§ä»Šå›ã¯çœç•¥ã€åŒç€ã‚ã‚Šï¼‰
        results.sort((a, b) => b.rank - a.rank);

        let winner = results[0];
        let isMeWinner = (winner.id === myId);
        let isDraw = (results.length > 1 && results[1].rank === winner.rank);

        let pot = results.length * BET_AMOUNT;
        
        // çµæœè¡¨ç¤ºç”¨ã®ãŸã‚ã€ã‚‚ã†ä¸€åº¦æç”»æ›´æ–°ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ãŸã„ãŒã€ä»Šå›ã¯å¼·åˆ¶çš„ã«HTMLæ›´æ–°
        // è‡ªåˆ†ã®ãƒãƒƒãƒ—æ›´æ–°
        if (isDraw) {
            resultMsg.innerText = "DRAW (å¼•ãåˆ†ã‘) Â±0";
            resultMsg.style.color = "#fff";
            // å¼•ãåˆ†ã‘ã¯ãƒãƒƒãƒ—å¤‰å‹•ãªã—ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰
        } else if (isMeWinner) {
            // å‹è€…ã¯å‚åŠ è€…å…¨å“¡åˆ†ã®å‚åŠ è²»(BET)ã‚’ã‚‚ã‚‰ãˆã‚‹ï¼ˆè‡ªåˆ†ã®ã¯æˆ»ã£ã¦ãã‚‹ï¼‹ç›¸æ‰‹ã®åˆ†ï¼‰
            // ã¤ã¾ã‚Šã€(ç·äººæ•°-1) * 100 ã®ãƒ—ãƒ©ã‚¹
            let profit = (results.length - 1) * BET_AMOUNT;
            resultMsg.innerText = `WIN!! (+$${profit}) ğŸ†`;
            resultMsg.style.color = "#f1c40f";
            myChips += profit;
        } else {
            // æ•—è€…ã¯å‚åŠ è²»ã‚’å–ã‚‰ã‚Œã‚‹
            resultMsg.innerText = `LOSE... (-$${BET_AMOUNT}) ğŸ˜¢`;
            resultMsg.style.color = "#e74c3c";
            myChips -= BET_AMOUNT;
        }

        saveChips();
        // æœ€æ–°ãƒãƒƒãƒ—ã‚’DBã¸
        db.ref(`rooms/${roomId}/players/${myId}/chips`).set(myChips);
        
        // ç›¸æ‰‹ã®æ‰‹æœ­ã‚’ã‚ªãƒ¼ãƒ—ãƒ³ã«ã™ã‚‹ãŸã‚ã«å†æç”»ã‚’ä¿ƒã™ï¼ˆisGameFinishedãŒtrueã«ãªã£ãŸã®ã§ï¼‰
        // listenToRoomãŒæ¬¡ã®DBæ›´æ–°ã§èµ°ã‚‹ã¯ãšã ãŒã€å¿µã®ãŸã‚æ‰‹å‹•æ›´æ–°ã‚‚å¯
        // ã“ã“ã§ã¯ç›¸æ‰‹ã®æ‰‹æœ­ãŒã‚ªãƒ¼ãƒ—ãƒ³ã«ãªã‚‹ã®ã‚’å¾…ã¤ï¼ˆupdateMyStatusãªã©ã‚’ã™ã‚Œã°èµ°ã‚‹ï¼‰
        updateMyStatus("ç¢ºå®šï¼"); 

        actionButtons.style.display = "flex";
    }

    function getHandName(dice) {
        if(!dice) return {rank:0, name:""};
        let counts = {};
        dice.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
        let values = Object.values(counts).sort((a,b) => b - a);
        let uniqueDice = [...new Set(dice)].sort().join('');
        let isStraight = (uniqueDice === '12345' || uniqueDice === '23456');

        // subRankã¯åŒç€åˆ¤å®šç”¨ã ãŒä»Šå›ã¯ç°¡æ˜“å®Ÿè£…
        if (values[0] === 5) return { rank: 8, name: "5ã‚«ãƒ¼ãƒ‰" };
        if (values[0] === 4) return { rank: 7, name: "4ã‚«ãƒ¼ãƒ‰" };
        if (values[0] === 3 && values[1] === 2) return { rank: 6, name: "ãƒ•ãƒ«ãƒã‚¦ã‚¹" };
        if (isStraight) return { rank: 5, name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ" };
        if (values[0] === 3) return { rank: 4, name: "3ã‚«ãƒ¼ãƒ‰" };
        if (values[0] === 2 && values[1] === 2) return { rank: 3, name: "2ãƒšã‚¢" };
        if (values[0] === 2) return { rank: 2, name: "1ãƒšã‚¢" };
        return { rank: 1, name: "ãƒ–ã‚¿" };
    }
</script>
</body>
</html>
