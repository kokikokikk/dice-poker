<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dice Poker Ex (Coin Fix)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { 
            background-color: #2c3e50; color: white; font-family: 'Segoe UI', sans-serif; 
            text-align: center; display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; margin: 0; padding-bottom: 50px; user-select: none; 
            touch-action: manipulation;
        }
        .container { max-width: 600px; width: 95%; padding: 10px; }
        
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-size: 1rem; cursor: pointer; margin: 5px; font-weight: bold; width: 100%; max-width: 300px; transition: 0.1s; touch-action: manipulation; }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-green { background-color: #27ae60; color: white; }
        .btn-blue { background-color: #2980b9; color: white; }
        .btn-orange { background-color: #e67e22; color: white; }
        .btn-red { background-color: #c0392b; color: white; }
        .btn-gray { background-color: #7f8c8d; color: white; }
        .btn-small { width: auto; font-size: 0.9rem; padding: 5px 15px; }

        .wallet-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .currency { padding: 8px 20px; border-radius: 50px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 5px; }
        .gold { background-color: #f1c40f; color: #2c3e50; border: 2px solid #f39c12; }
        .silver { background-color: #bdc3c7; color: #2c3e50; border: 2px solid #95a5a6; }

        .dice-area { display: flex; justify-content: center; gap: 5px; margin: 10px 0; min-height: 50px; }
        .die { width: 45px; height: 45px; background: white; color: #333; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; border: 2px solid #bdc3c7; cursor: pointer; transition: 0.1s; box-shadow: 0 3px 0 #95a5a6; touch-action: manipulation; }
        .die.held { background: #f1c40f; border-color: #e67e22; transform: translateY(-3px); box-shadow: 0 6px 3px rgba(0,0,0,0.2); }
        .die.locked { background: #ecf0f1; color: #95a5a6; cursor: default; }
        .die.cpu { background: #e0e0e0; cursor: default; width: 30px; height: 30px; font-size: 16px; border-width: 1px; }

        .opponents-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .opponent-card { background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; min-width: 120px; position: relative; }
        .op-name { font-size: 0.8rem; color: #f1c40f; font-weight: bold; margin-bottom: 3px; }
        .op-gold { font-size: 0.7rem; color: #f39c12; margin-bottom: 3px; font-weight: bold; }
        .op-status { font-size: 0.7rem; color: #bdc3c7; margin-bottom: 3px; }
        .op-dice-row { display: flex; gap: 2px; }
        
        .waiting-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); border-radius:8px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:0.7rem; font-weight:bold; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal { background: #34495e; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; text-align: left; border: 2px solid #f1c40f; }
        .modal h2 { margin-top: 0; color: #f1c40f; text-align: center; }
        .hand-list { font-size: 0.9rem; line-height: 1.6; }
        .hand-rank { font-weight: bold; color: #e67e22; }

        .screen { display: none; }
        .active { display: block !important; }

        input { padding: 10px; font-size: 1rem; text-align: center; border-radius: 5px; border: 1px solid #ccc; width: 80%; max-width: 250px; }
        .status { margin: 10px; font-size: 1.2rem; color: #f39c12; font-weight: bold; }
        .info-text { font-size: 0.9rem; color: #bdc3c7; margin: 5px 0; }
        .action-row { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        
        #sync-message {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; border: 2px solid #e67e22;
            z-index: 50; display: none; width: 80%; max-width: 400px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ² Dice Poker Ex</h1>

    <div class="wallet-bar">
        <div class="currency gold">ğŸ’° <span id="disp-gold">---</span></div>
        <div class="currency silver">ğŸª™ <span id="disp-silver">---</span></div>
    </div>

    <div id="lobby-screen" class="screen active">
        <button class="btn btn-small btn-gray" onclick="toggleRuleModal(true)">ğŸ“– ãƒ«ãƒ¼ãƒ«ã¨å½¹ã‚’è¦‹ã‚‹</button>
        <br><br>

        <label style="font-size:0.8rem; color:#bdc3c7;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label><br>
        <input type="text" id="player-name-input" placeholder="åå‰ã‚’å…¥åŠ›" onchange="saveName()">
        <br><br>

        <h3>ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ (Gold)</h3>
        <p class="info-text">å‚åŠ è²»: 100 Gold</p>
        <div style="margin: 5px 0;">
            <input type="text" id="room-id-input" placeholder="éƒ¨å±‹ID (ä¾‹: 1234)">
        </div>
        <button class="btn btn-green" onclick="joinMultiplayerRoom()">éƒ¨å±‹ã«å…¥å®¤ / ä½œæˆ</button>

        <hr style="border-color:rgba(255,255,255,0.1); margin: 20px 0;">

        <h3>ğŸ¤– CPUå¯¾æˆ¦ (Silver)</h3>
        <p class="info-text">å‚åŠ è²»: <span id="cpu-cost-display" style="color:#f1c40f; font-weight:bold;">50</span> Silver</p>
        <select id="cpu-level" onchange="updateCpuCost()" style="padding:10px; border-radius:5px; font-size:1rem; width:250px; margin-bottom:10px;">
            <option value="1">Level 1: åˆå¿ƒè€… (20 Silver)</option>
            <option value="2" selected>Level 2: ä¸€èˆ¬äºº (50 Silver)</option>
            <option value="3">Level 3: è³­åšå¸« (100 Silver)</option>
        </select>
        <br>
        <button class="btn btn-orange" onclick="startCpuGame()">CPUã¨æˆ¦ã†</button>
        
        <br><br>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
            <button class="btn btn-small btn-gray" onclick="resetSilver()" style="border:2px solid #bdc3c7;">ğŸª™ Silverè£œå……</button>
            <button class="btn btn-small btn-green" onclick="resetGold()" style="border:2px solid #f1c40f;">ğŸ’° Goldè£œå……</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div style="font-size:0.9rem; color:#bdc3c7;" id="game-info">Mode: ---</div>
        
        <div id="opponents-container" class="opponents-grid">
            </div>

        <div id="result-msg" style="font-size:1.5rem; font-weight:bold; margin:10px 0; min-height:2rem; white-space: pre-wrap;"></div>

        <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px;">
            <div class="status">ã‚ãªãŸ: <span id="my-status">æº–å‚™ä¸­</span></div>
            <div class="dice-area" id="my-dice-area"></div>
            <div id="my-hand-name" style="font-size:1.1rem; color:#f1c40f; font-weight:bold;"></div>
            
            <button id="roll-btn" class="btn btn-green" onclick="rollAction()">ROLL (3å›)</button>
        </div>

        <div id="action-area" style="margin-top:20px; display:none;">
            <div class="action-row" id="cpu-actions" style="display:none;">
                <button class="btn btn-orange" onclick="restartCpuGame()">ğŸ”„ ã‚‚ã†ä¸€å› ($<span id="replay-cost"></span>)</button>
                <button class="btn btn-gray" onclick="backToLobby()">ğŸ  ãƒ­ãƒ“ãƒ¼ã¸</button>
            </div>
            <div class="action-row" id="multi-actions" style="display:none;">
                <button class="btn btn-orange" onclick="restartMultiGame()">ğŸ”„ ã‚‚ã†ä¸€å› ($100)</button>
                <button class="btn btn-gray" onclick="backToLobby()">ğŸ  é€€å®¤ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="sync-message">
        <h3>â³ <span id="sync-title">å¾…æ©Ÿä¸­...</span></h3>
        <p id="sync-text">ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã€Œã‚‚ã†ä¸€å›ã€ã‚’æŠ¼ã™ã®ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚</p>
        <button id="sync-exit-btn" class="btn btn-red btn-small" style="display:none; margin-top:10px;" onclick="backToLobby()">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
        <div style="font-size:2rem; margin-top:10px;">ğŸ²</div>
    </div>

</div>

<div id="rule-modal" class="modal-overlay" onclick="toggleRuleModal(false)">
    <div class="modal" onclick="event.stopPropagation()">
        <h2>ğŸ“– ãƒ«ãƒ¼ãƒ« & å½¹ä¸€è¦§</h2>
        <p>å½¹ã®å¼·ã•é †:</p>
        <div class="hand-list">
            <span class="hand-rank">1. 5ã‚«ãƒ¼ãƒ‰</span> (åŒã˜æ•°5ã¤)<br>
            <span class="hand-rank">2. 4ã‚«ãƒ¼ãƒ‰</span> (åŒã˜æ•°4ã¤)<br>
            <span class="hand-rank">3. ãƒ•ãƒ«ãƒã‚¦ã‚¹</span> (3ã¤+2ã¤)<br>
            <span class="hand-rank">4. ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ</span> (12345 / 23456)<br>
            <span class="hand-rank">5. 3ã‚«ãƒ¼ãƒ‰</span> (åŒã˜æ•°3ã¤)<br>
            <span class="hand-rank">6. 2ãƒšã‚¢</span><br>
            <span class="hand-rank">7. 1ãƒšã‚¢</span><br>
            <span class="hand-rank">8. ãƒ–ã‚¿ (High Card)</span>
        </div>
        <br>
        <button class="btn btn-green" onclick="toggleRuleModal(false)">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyD0micFDoWAHMpZdY2IPhjW3v2XLqloJX8",
      authDomain: "dice-poker-e9021.firebaseapp.com",
      databaseURL: "https://dice-poker-e9021-default-rtdb.firebaseio.com",
      projectId: "dice-poker-e9021",
      storageBucket: "dice-poker-e9021.firebasestorage.app",
      messagingSenderId: "730416248000",
      appId: "1:730416248000:web:349072ce1b17bcc139e925",
      measurementId: "G-KP58T1CMFN"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Settings
    const BET_GOLD = 100;
    const CPU_BETS = { 1: 20, 2: 50, 3: 100 };

    let myName = "Player";
    let myGold = 1000;
    let mySilver = 500;
    let myId = null; 
    
    let gameMode = null; 
    let cpuLevel = 2;
    let currentCpuBet = 50;
    let roomId = null;
    let myRound = 1; 
    
    let myDice = [1,1,1,1,1];
    let heldDice = [false,false,false,false,false];
    let rollCount = 3;
    let isGameFinished = false;

    // DOM Elements
    const lobbyScreen = document.getElementById('lobby-screen');
    const gameScreen = document.getElementById('game-screen');
    const myDiceDiv = document.getElementById('my-dice-area');
    const opponentsDiv = document.getElementById('opponents-container');
    const rollBtn = document.getElementById('roll-btn');
    const resultMsg = document.getElementById('result-msg');
    const actionArea = document.getElementById('action-area');
    const myStatus = document.getElementById('my-status');
    const nameInput = document.getElementById('player-name-input');
    const cpuCostDisplay = document.getElementById('cpu-cost-display');
    const syncMsg = document.getElementById('sync-message');
    const syncText = document.getElementById('sync-text');
    const syncExitBtn = document.getElementById('sync-exit-btn');

    // Init
    loadWallet();
    updateCpuCost();
    myId = 'p_' + Math.random().toString(36).substr(2, 9);

    function loadWallet() {
        myGold = parseInt(localStorage.getItem('dp_gold') || 1000);
        mySilver = parseInt(localStorage.getItem('dp_silver') || 500);
        myName = localStorage.getItem('dp_name') || "Player";
        nameInput.value = myName;
        updateWalletUI();
    }
    function saveWallet() {
        localStorage.setItem('dp_gold', myGold);
        localStorage.setItem('dp_silver', mySilver);
        updateWalletUI();
    }
    function saveName() {
        myName = nameInput.value || "Player";
        localStorage.setItem('dp_name', myName);
    }
    function updateWalletUI() {
        document.getElementById('disp-gold').innerText = myGold;
        document.getElementById('disp-silver').innerText = mySilver;
    }
    function resetSilver() {
        if(!confirm("Silverã‚’500ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;
        mySilver = 500; saveWallet(); updateWalletUI();
    }
    function resetGold() {
        if(!confirm("Goldã‚’1000ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;
        myGold = 1000; saveWallet(); updateWalletUI();
    }
    function toggleRuleModal(show) { document.getElementById('rule-modal').style.display = show ? 'flex' : 'none'; }
    function updateCpuCost() {
        let lv = parseInt(document.getElementById('cpu-level').value);
        cpuCostDisplay.innerText = CPU_BETS[lv];
    }

    function backToLobby() {
        if(gameMode === 'multi' && roomId) {
            db.ref(`rooms/${roomId}/players/${myId}`).remove();
        }
        window.location.reload();
    }

    // --- 1. CPU Mode ---
    function startCpuGame() {
        saveName();
        cpuLevel = parseInt(document.getElementById('cpu-level').value);
        currentCpuBet = CPU_BETS[cpuLevel];
        if(mySilver < currentCpuBet) return alert("SilverãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        
        mySilver -= currentCpuBet;
        saveWallet();
        gameMode = 'cpu';
        
        setupGameScreen(`Mode: CPU Battle (Lv.${cpuLevel})`);
        // CPUã¯Goldã‚’æŒãŸãªã„ã®ã§null
        renderOpponentCard('cpu', "CPU (Lv."+cpuLevel+")", "Thinking...", [0,0,0,0,0], false, true, null);
        
        document.getElementById('cpu-actions').style.display = 'flex';
        document.getElementById('multi-actions').style.display = 'none';
        document.getElementById('replay-cost').innerText = currentCpuBet;
    }

    function restartCpuGame() {
        if(mySilver < currentCpuBet) return alert("SilverãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        mySilver -= currentCpuBet;
        saveWallet();
        
        resetGameState();
        renderOpponentCard('cpu', "CPU (Lv."+cpuLevel+")", "Thinking...", [0,0,0,0,0], false, true, null);
    }

    // --- 2. Multiplayer Mode ---
    function joinMultiplayerRoom() {
        saveName();
        roomId = document.getElementById('room-id-input').value;
        if(!roomId) return alert("éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if(myGold < BET_GOLD) return alert("GoldãŒè¶³ã‚Šã¾ã›ã‚“ï¼");

        gameMode = 'multi';
        myGold -= BET_GOLD;
        saveWallet();

        db.ref(`rooms/${roomId}/players`).once('value', snap => {
            const players = snap.val();
            let joinRound = 1;
            if (players) {
                let maxR = 1;
                Object.values(players).forEach(p => { if(p.round > maxR) maxR = p.round; });
                joinRound = maxR;
            }
            myRound = joinRound;
            
            db.ref(`rooms/${roomId}/players/${myId}`).set({
                name: myName,
                gold: myGold, // Goldæƒ…å ±ã‚’é€ä¿¡
                dice: [0,0,0,0,0],
                status: 'Thinking',
                rollCount: 3,
                finished: false,
                round: myRound
            });
            db.ref(`rooms/${roomId}/players/${myId}`).onDisconnect().remove();

            setupGameScreen(`Mode: Online (Room ${roomId})`);
            document.getElementById('cpu-actions').style.display = 'none';
            document.getElementById('multi-actions').style.display = 'flex';
            
            listenToRoom();
        });
    }

    function restartMultiGame() {
        if(myGold < BET_GOLD) return alert("GoldãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        myGold -= BET_GOLD;
        saveWallet();

        myRound++;
        resetGameState();

        db.ref(`rooms/${roomId}/players/${myId}`).update({
            dice: [0,0,0,0,0],
            status: 'Thinking',
            rollCount: 3,
            finished: false,
            round: myRound,
            gold: myGold // æ›´æ–°ã—ãŸGoldã‚’é€ä¿¡
        });
        
        syncMsg.style.display = 'block';
        syncText.innerText = "ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æº–å‚™ã‚’å¾…ã£ã¦ã„ã¾ã™...";
        syncExitBtn.style.display = 'none';
        rollBtn.disabled = true;
    }

    // --- Main Logic: éƒ¨å±‹ç›£è¦– ---
    function listenToRoom() {
        db.ref(`rooms/${roomId}/players`).on('value', snap => {
            const players = snap.val();
            if(!players) return; 

            let allSynced = true;
            let activeOpponents = 0;
            let everyoneFinished = true;
            let opponentHands = [];

            Object.keys(players).forEach(pid => {
                const p = players[pid];
                if(pid !== myId) {
                    activeOpponents++;
                    if(p.round < myRound) allSynced = false;
                }
                if (p.round !== myRound || !p.finished) {
                    everyoneFinished = false;
                }
            });

            if (syncMsg.style.display === 'block') {
                if (activeOpponents === 0) {
                    syncText.innerText = "ç›¸æ‰‹ãŒã„ãªããªã‚Šã¾ã—ãŸ...";
                    syncExitBtn.style.display = 'inline-block';
                } else if (allSynced) {
                    syncMsg.style.display = 'none';
                    if(!isGameFinished) rollBtn.disabled = false;
                } else {
                    syncText.innerText = "ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æº–å‚™ã‚’å¾…ã£ã¦ã„ã¾ã™...";
                    syncExitBtn.style.display = 'none';
                }
            }

            opponentsDiv.innerHTML = '';
            
            Object.keys(players).forEach(pid => {
                if (pid === myId) return;

                const p = players[pid];
                const isSameRound = (p.round === myRound);
                const showDice = p.finished && isSameRound && everyoneFinished;
                
                let displayStatus = p.status;
                if (!isSameRound) displayStatus = "æº–å‚™ä¸­..."; 

                // Goldæƒ…å ±ã‚’æ¸¡ã™
                renderOpponentCard(pid, p.name, displayStatus, p.dice, showDice, isSameRound, p.gold);
                
                if (isSameRound && p.finished) {
                    opponentHands.push({ name: p.name, dice: p.dice });
                }
            });

            if(everyoneFinished && rollCount === 0 && !isGameFinished) {
                opponentHands.push({ name: "ã‚ãªãŸ", dice: myDice });
                finishGameMulti(opponentHands);
            }
        });
    }

    // --- Visuals ---
    function setupGameScreen(infoText) {
        lobbyScreen.classList.remove('active');
        gameScreen.classList.add('active');
        document.getElementById('game-info').innerText = infoText;
        resetGameState();
    }

    function resetGameState() {
        rollCount = 3;
        heldDice = [false,false,false,false,false];
        isGameFinished = false;
        resultMsg.innerText = "";
        actionArea.style.display = 'none';
        syncMsg.style.display = 'none';
        
        rollBtn.disabled = false;
        rollBtn.innerText = "ROLL (3å›)";
        rollBtn.className = "btn btn-green";
        myStatus.innerText = "æº–å‚™OK";
        
        document.getElementById('my-hand-name').innerText = "";
        initMyDiceUI();
    }

    function initMyDiceUI() {
        myDiceDiv.innerHTML = '';
        for(let i=0; i<5; i++){
            let d = document.createElement('div');
            d.className = 'die';
            d.innerText = '-';
            d.onclick = () => toggleHold(i, d);
            myDiceDiv.appendChild(d);
        }
    }

    function toggleHold(i, el) {
        if(rollCount <= 0 || rollCount === 3 || isGameFinished) return;
        heldDice[i] = !heldDice[i];
        if(heldDice[i]) el.classList.add('held'); else el.classList.remove('held');
    }

    // ç›¸æ‰‹ã‚«ãƒ¼ãƒ‰æç”» (Goldè¿½åŠ )
    function renderOpponentCard(id, name, status, dice, showDice, isActive, gold) {
        let card = document.createElement('div');
        card.className = 'opponent-card';
        if (!isActive) card.style.opacity = "0.6"; 

        let goldHtml = (gold !== undefined && gold !== null) ? `<div class="op-gold">ğŸ’°${gold}</div>` : "";

        let html = `<div class="op-name">${name}</div>
                    ${goldHtml}
                    <div class="op-status">${status}</div>
                    <div class="op-dice-row">`;
        
        if (!isActive) html += `<div class="waiting-overlay">å¾…æ©Ÿä¸­</div>`;
        
        dice.forEach(val => {
            let displayVal = showDice ? val : "?";
            let style = showDice ? "background:white; color:#333;" : "";
            html += `<div class="die cpu" style="${style}">${displayVal}</div>`;
        });
        html += `</div>`;
        card.innerHTML = html;
        opponentsDiv.appendChild(card);
    }

    // --- Game Action ---
    function rollAction() {
        if(rollCount <= 0) return;
        
        for(let i=0; i<5; i++){
            if(!heldDice[i]) myDice[i] = Math.floor(Math.random()*6)+1;
        }
        rollCount--;
        
        let dies = myDiceDiv.children;
        for(let i=0; i<5; i++) dies[i].innerText = myDice[i];
        
        if(rollCount < 3) {
            document.getElementById('my-hand-name').innerText = getHand(myDice).name;
        }

        let statusText = (rollCount === 0) ? "ç¢ºå®šï¼" : "è€ƒãˆä¸­...";
        myStatus.innerText = statusText;

        rollBtn.innerText = (rollCount > 0) ? `REROLL (${rollCount})` : "å¾…æ©Ÿä¸­...";
        if(rollCount === 0) {
            rollBtn.disabled = true;
            rollBtn.className = "btn btn-gray";
        }

        if(gameMode === 'multi') {
            db.ref(`rooms/${roomId}/players/${myId}`).update({ 
                dice: myDice, 
                status: statusText,
                finished: (rollCount === 0),
                rollCount: rollCount,
                round: myRound
            });
        } else {
            runCpuProcess();
        }
    }

    function runCpuProcess() {
        if(isGameFinished) return;
        opponentsDiv.innerHTML = ''; 
        // CPUã¯Goldãªã—
        renderOpponentCard('cpu', "CPU", "Rolling...", [0,0,0,0,0], false, true, null);

        if(rollCount === 0) {
            setTimeout(() => {
                let cpuD = [0,0,0,0,0];
                let cpuHeld = [false,false,false,false,false];
                for(let turn=0; turn<3; turn++) {
                    for(let i=0; i<5; i++) { if(!cpuHeld[i]) cpuD[i] = Math.floor(Math.random()*6)+1; }
                    if(turn < 2) cpuHeld = decideCpuHold(cpuD, cpuLevel);
                }
                
                opponentsDiv.innerHTML = ''; 
                renderOpponentCard('cpu', "CPU", "Finish!", cpuD, true, true, null);
                
                finishGameMulti([
                    { name: "CPU", dice: cpuD },
                    { name: "ã‚ãªãŸ", dice: myDice }
                ]);
            }, 800);
        }
    }

    function decideCpuHold(dice, level) {
        let held = [false,false,false,false,false];
        let counts = {};
        dice.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
        if(level === 1) { dice.forEach((val, i) => { if(val === 6 || Math.random() > 0.7) held[i] = true; }); }
        else if (level === 2) { dice.forEach((val, i) => { if(counts[val] >= 2) held[i] = true; }); }
        else { 
            let maxCount = Math.max(...Object.values(counts));
            if(maxCount >= 2) dice.forEach((val, i) => { if(counts[val] >= 2) held[i] = true; });
            else dice.forEach((val, i) => { if(val >= 4) held[i] = true; });
        }
        return held;
    }

    function finishGameMulti(playersData) {
        isGameFinished = true;
        let results = playersData.map(p => { return { name: p.name, hand: getHand(p.dice) }; });
        results.sort((a, b) => {
            if (b.hand.rank !== a.hand.rank) return b.hand.rank - a.hand.rank;
            return b.hand.sum - a.hand.sum;
        });

        let winner = results[0];
        let isWin = (winner.name === "ã‚ãªãŸ");
        let isDraw = (!isWin && winner.hand.rank === getHand(myDice).rank && winner.hand.sum === getHand(myDice).sum);

        let msg = `ğŸ† 1ä½: ${winner.name} (${winner.hand.name})`;
        let color = "#e74c3c"; 

        if (isWin) {
            msg = "ğŸ† YOU WIN!!\n1ä½: ã‚ãªãŸ";
            color = "#f1c40f";
            if(gameMode === 'cpu') {
                let bonus = (cpuLevel - 1) * 20; 
                let reward = (currentCpuBet * 2) + bonus;
                mySilver += reward; msg += ` (+${reward - currentCpuBet} Silver)`;
            } else {
                myGold += (BET_GOLD * 2); msg += ` (+${BET_GOLD} Gold)`;
            }
        } else if (isDraw && winner.name.includes("ã‚ãªãŸ")) { 
             msg = "ğŸ¤ DRAW (åŒç‡1ä½)"; color = "#fff";
             if(gameMode === 'cpu') mySilver += currentCpuBet; else myGold += BET_GOLD;
        }

        resultMsg.innerText = msg;
        resultMsg.style.color = color;
        saveWallet();
        actionArea.style.display = 'block';
    }

    function getHand(dice) {
        if(!dice || dice.includes(0)) return {rank:0, name:"---", sum:0};
        let counts = {};
        let sum = 0;
        dice.forEach(x => { counts[x] = (counts[x] || 0) + 1; sum += x; });
        let values = Object.values(counts).sort((a,b) => b - a);
        let uniqueDice = [...new Set(dice)].sort().join('');
        let isStraight = (uniqueDice === '12345' || uniqueDice === '23456');

        if (values[0] === 5) return { rank: 8, name: "5ã‚«ãƒ¼ãƒ‰", sum };
        if (values[0] === 4) return { rank: 7, name: "4ã‚«ãƒ¼ãƒ‰", sum };
        if (values[0] === 3 && values[1] === 2) return { rank: 6, name: "ãƒ•ãƒ«ãƒã‚¦ã‚¹", sum };
        if (isStraight) return { rank: 5, name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ", sum };
        if (values[0] === 3) return { rank: 4, name: "3ã‚«ãƒ¼ãƒ‰", sum };
        if (values[0] === 2 && values[1] === 2) return { rank: 3, name: "2ãƒšã‚¢", sum };
        if (values[0] === 2) return { rank: 2, name: "1ãƒšã‚¢", sum };
        return { rank: 1, name: "ãƒ–ã‚¿", sum };
    }
</script>
</body>
</html>
